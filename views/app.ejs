<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="shopify-api-key" content="<%= SHOPIFY_API_KEY %>">
  <title>Delybell Order Sync Dashboard</title>
  
  <!-- Shopify App Bridge -->
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge-utils.js"></script>
  <script>
    window.SHOPIFY_API_KEY = '<%= SHOPIFY_API_KEY %>';
    window.SHOPIFY_SHOP = '<%= shop %>';
  </script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#008060", // Shopify Polaris Green
            "background-light": "#f6f6f7",
            "background-dark": "#1a1a1a",
            "surface-light": "#ffffff",
            "surface-dark": "#2a2a2a",
            "border-light": "#e1e3e5",
            "border-dark": "#3e3e3e",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            sans: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "8px",
          },
        },
      },
    };
  </script>
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    .polaris-shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .toast {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-left: 4px solid #008060;
      border-radius: 6px;
      padding: 14px 18px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 300px;
      max-width: 400px;
      display: flex;
      align-items: start;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }
    
    .dark .toast {
      background: #2a2a2a;
      border-color: #3e3e3e;
    }
    
    .toast.success { border-left-color: #008060; }
    .toast.error { border-left-color: #d72c0d; }
    .toast.warning { border-left-color: #f59e0b; }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #ffffff;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .dark .modal-content {
      background: #2a2a2a;
      color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200">
  <div class="max-w-[1200px] mx-auto px-6 py-8">
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Header -->
    <header class="mb-8 flex justify-between items-end">
      <div>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Delybell Order Sync</h1>
        <p class="text-slate-500 dark:text-slate-400 mt-1">Simple delivery automation for your Shopify store</p>
      </div>
      <div class="flex gap-3">
        <button class="px-4 py-2 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded font-medium text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Help Center</button>
        <button class="px-4 py-2 bg-primary text-white rounded font-medium text-sm hover:opacity-90 transition-opacity" onclick="loadOrders(currentPage)">Sync Now</button>
      </div>
    </header>
    
    <!-- App Content -->
    <div id="app-content">
      <div class="flex items-center justify-center py-20">
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
          <p class="text-slate-500 dark:text-slate-400">Loading...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Dark Mode Toggle -->
  <div class="fixed bottom-6 right-6">
    <button class="p-3 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-full shadow-lg hover:scale-110 transition-transform" onclick="document.documentElement.classList.toggle('dark')">
      <span class="material-icons-outlined dark:hidden">dark_mode</span>
      <span class="material-icons-outlined hidden dark:block text-yellow-400">light_mode</span>
    </button>
  </div>
  
  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="font-bold text-lg mb-4" id="modalTitle">Confirm Action</div>
      <div class="text-slate-600 dark:text-slate-400 mb-6" id="modalBody">Are you sure?</div>
      <div class="flex gap-3 justify-end">
        <button class="px-4 py-2 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded font-medium text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" onclick="closeModal()">Cancel</button>
        <button class="px-4 py-2 bg-primary text-white rounded font-medium text-sm hover:opacity-90 transition-opacity" id="modalConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>
  
  <script>
    let app;
    let shop = window.SHOPIFY_SHOP || '<%= shop %>';
    const apiKey = window.SHOPIFY_API_KEY;
    let currentSyncMode = 'manual';
    let currentPage = 1;
    let pageSize = 10;
    let totalOrders = 0;
    let currentTab = 'all';
    
    // Toast Notification System
    function showToast(type, title, message, duration = 5000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '<span class="material-icons-outlined text-green-600 dark:text-green-400">check_circle</span>',
        error: '<span class="material-icons-outlined text-red-600 dark:text-red-400">error</span>',
        warning: '<span class="material-icons-outlined text-yellow-600 dark:text-yellow-400">warning</span>'
      };
      
      toast.innerHTML = `
        ${icons[type] || icons.success}
        <div style="flex: 1;">
          <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
          ${message ? `<div style="font-size: 13px; color: #6d7175;">${message}</div>` : ''}
        </div>
        <span class="material-icons-outlined cursor-pointer text-slate-400 hover:text-slate-600 dark:hover:text-slate-300" onclick="this.parentElement.remove()" style="font-size: 20px;">close</span>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // Initialize App Bridge
    if (apiKey && apiKey !== 'SHOPIFY_API_KEY_NOT_SET' && apiKey !== '<%= SHOPIFY_API_KEY %>') {
      try {
        if (window['app-bridge']) {
          const AppBridge = window['app-bridge'].default;
          const createApp = AppBridge.default;
          
          const appConfig = { apiKey: apiKey };
          if (shop) appConfig.shopOrigin = shop;
          
          window.app = createApp(appConfig);
          
          if (AppBridge.actions) {
            const TitleBar = AppBridge.actions.TitleBar;
            TitleBar.create(window.app, { title: 'Delybell Order Sync' });
          }
        }
      } catch (appBridgeError) {
        console.warn('App Bridge initialization failed:', appBridgeError);
      }
    }
    
    if (!shop) {
      const urlParams = new URLSearchParams(window.location.search);
      shop = urlParams.get('shop') || urlParams.get('shopOrigin');
    }
    
    // Human-readable error messages
    function getFriendlyError(errorMessage) {
      if (!errorMessage) return 'Unknown error occurred';
      
      const error = errorMessage.toLowerCase();
      
      if (error.includes('block') && error.includes('not found')) {
        return 'Address issue: Block not found. Ask customer to re-check address.';
      }
      if (error.includes('road') && error.includes('not found')) {
        return 'Address issue: Road not found. Order will sync with block only.';
      }
      if (error.includes('building') && error.includes('not found')) {
        return 'Address issue: Building not found. Order will sync without building.';
      }
      if (error.includes('validation')) {
        return 'Address validation failed. Please check customer address details.';
      }
      if (error.includes('network') || error.includes('timeout')) {
        return 'Connection issue: Unable to reach Delybell. Please try again.';
      }
      if (error.includes('authentication') || error.includes('unauthorized')) {
        return 'Authentication failed. Please contact support.';
      }
      
      return errorMessage.length > 100 ? errorMessage.substring(0, 100) + '...' : errorMessage;
    }
    
    // Modal functions
    function showModal(title, body, onConfirm) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').textContent = body;
      const confirmBtn = document.getElementById('modalConfirmBtn');
      confirmBtn.onclick = () => {
        onConfirm();
        closeModal();
      };
      document.getElementById('confirmModal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('confirmModal').classList.remove('active');
    }
    
    // Toggle settings
    function toggleSettings() {
      const content = document.getElementById('settingsContent');
      const icon = document.getElementById('settingsIcon');
      if (content && icon) {
        content.classList.toggle('hidden');
        icon.textContent = content.classList.contains('hidden') ? 'expand_more' : 'expand_less';
      }
    }
    
    // Load connection health
    async function loadConnectionHealth() {
      if (!shop) return { shopify: false, delybell: false, lastSync: null };
      
      try {
        const authResponse = await fetch(`/auth/check?shop=${encodeURIComponent(shop)}`);
        const authData = await authResponse.json();
        const shopifyConnected = authData.authenticated || false;
        
        let delybellConnected = false;
        try {
          const blocksResponse = await fetch('/admin/api/delybell-health');
          if (blocksResponse.ok) {
            const blocksData = await blocksResponse.json();
            delybellConnected = blocksData.success || false;
          }
        } catch (e) {
          console.warn('Delybell health check failed:', e);
        }
        
        const statsResponse = await fetch(`/admin/api/stats?shop=${encodeURIComponent(shop)}`);
        const statsData = await statsResponse.json();
        const lastSync = statsData.success && statsData.stats.successfullySynced > 0 
          ? 'Just now' 
          : null;
        
        return {
          shopify: shopifyConnected,
          delybell: delybellConnected,
          lastSync: lastSync,
          storeDomain: shop
        };
      } catch (error) {
        console.error('Error loading connection health:', error);
        return { shopify: false, delybell: false, lastSync: null, storeDomain: shop };
      }
    }
    
    // Load sync mode
    async function loadSyncMode() {
      if (!shop) return;
      
      try {
        const response = await fetch(`/admin/api/shops/${encodeURIComponent(shop)}/sync-mode`);
        const data = await response.json();
        if (data.success) {
          currentSyncMode = data.sync_mode || 'manual';
          updateSyncModeUI();
        }
      } catch (error) {
        console.error('Error loading sync mode:', error);
        currentSyncMode = 'manual';
        updateSyncModeUI();
      }
    }
    
    function updateSyncModeUI() {
      const autoBtn = document.getElementById('autoSyncBtn');
      const manualBtn = document.getElementById('manualSyncBtn');
      const syncModeBadge = document.getElementById('syncModeBadge');
      const syncModeDescription = document.getElementById('syncModeDescription');
      const manualControls = document.getElementById('manualSyncControls');
      
      if (autoBtn && manualBtn) {
        if (currentSyncMode === 'auto') {
          autoBtn.className = 'px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white';
          manualBtn.className = 'px-4 py-1.5 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200';
        } else {
          autoBtn.className = 'px-4 py-1.5 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200';
          manualBtn.className = 'px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white';
        }
      }
      
      if (syncModeBadge) {
        syncModeBadge.textContent = currentSyncMode === 'auto' ? 'Auto' : 'Manual';
        syncModeBadge.className = currentSyncMode === 'auto' 
          ? 'px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-bold uppercase rounded'
          : 'px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-[10px] font-bold uppercase rounded';
      }
      
      if (syncModeDescription) {
        if (currentSyncMode === 'auto') {
          syncModeDescription.innerHTML = `
            <div class="bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30 rounded-lg p-4 flex items-start space-x-3">
              <span class="material-icons-outlined text-blue-600 dark:text-blue-400 mt-0.5">info</span>
              <div>
                <h3 class="font-semibold text-blue-900 dark:text-blue-300 text-sm">How Auto Sync Works</h3>
                <p class="text-blue-800 dark:text-blue-400/80 text-sm mt-1 leading-relaxed">
                  When a customer places an order in your Shopify store, it will <span class="font-bold">automatically sync to Delybell</span> within seconds. No action needed from you — orders appear in Delybell immediately.
                </p>
              </div>
            </div>
          `;
        } else {
          syncModeDescription.innerHTML = `
            <div class="bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30 rounded-lg p-4 flex items-start space-x-3">
              <span class="material-icons-outlined text-yellow-600 dark:text-yellow-400 mt-0.5">info</span>
              <div>
                <h3 class="font-semibold text-yellow-900 dark:text-yellow-300 text-sm">How Manual Sync Works</h3>
                <p class="text-yellow-800 dark:text-yellow-400/80 text-sm mt-1 leading-relaxed">
                  Orders are <span class="font-bold">saved but not synced automatically</span>. You can review orders and choose which ones to sync to Delybell. Use the checkboxes in the orders table below to select orders, then click "Sync Selected" when ready.
                </p>
              </div>
            </div>
          `;
        }
      }
      
      if (manualControls) {
        manualControls.classList.toggle('hidden', currentSyncMode === 'auto');
      }
      
      loadOrders();
    }
    
    async function updateSyncMode(mode) {
      if (!shop) {
        showToast('error', 'Error', 'Shop not detected');
        return;
      }
      
      try {
        const response = await fetch(`/admin/api/shops/${encodeURIComponent(shop)}/sync-mode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sync_mode: mode }),
        });
        
        const data = await response.json();
        if (data.success) {
          currentSyncMode = mode;
          updateSyncModeUI();
          showToast('success', 'Sync Mode Updated', `Switched to ${mode === 'auto' ? 'Auto Sync' : 'Manual Sync'} mode`);
        } else {
          showToast('error', 'Update Failed', data.error || 'Failed to update sync mode');
        }
      } catch (error) {
        console.error('Error updating sync mode:', error);
        showToast('error', 'Error', 'Failed to update sync mode');
      }
    }
    
    // Load orders with pagination and filtering
    async function loadOrders(page = 1, statusFilter = null) {
      if (!shop) return;
      
      currentPage = page;
      const ordersContainer = document.getElementById('ordersContainer');
      
      if (ordersContainer) {
        ordersContainer.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary mb-2"></div>
              <div>Loading orders...</div>
            </td>
          </tr>
        `;
      }
      
      try {
        const params = new URLSearchParams();
        params.append('shop', shop);
        params.append('limit', pageSize);
        params.append('offset', (page - 1) * pageSize);
        
        if (statusFilter && statusFilter !== 'all') {
          params.append('status', statusFilter);
        }
        
        const response = await fetch(`/admin/api/orders?${params}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load orders');
        }
        
        const orders = data.orders || [];
        totalOrders = data.total !== undefined ? data.total : orders.length;
        
        if (orders.length === 0) {
          if (ordersContainer) {
            ordersContainer.innerHTML = `
              <tr>
                <td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
                  <span class="material-icons-outlined text-4xl mb-2 block">inbox</span>
                  <div class="font-semibold">No orders yet</div>
                  <div class="text-sm mt-1">Orders will appear here once they are synced.</div>
                </td>
              </tr>
            `;
          }
          updatePagination();
          return;
        }
        
        renderOrders(orders);
        updatePagination();
        updateOrderTabs();
      } catch (error) {
        console.error('Error loading orders:', error);
        if (ordersContainer) {
          ordersContainer.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-red-600 dark:text-red-400">
                <span class="material-icons-outlined text-4xl mb-2 block">error</span>
                <div class="font-semibold">Error loading orders</div>
                <div class="text-sm mt-1">${error.message}</div>
              </td>
            </tr>
          `;
        }
      }
    }
    
    // Update order tabs with counts
    async function updateOrderTabs() {
      try {
        const statsResponse = await fetch(`/admin/api/stats?shop=${encodeURIComponent(shop)}`);
        const statsData = await statsResponse.json();
        
        if (statsData.success) {
          const stats = statsData.stats;
          const syncedCount = stats.successfullySynced || 0;
          const pendingCount = stats.pendingSync || 0;
          const failedCount = stats.failed || 0;
          const totalCount = stats.totalOrdersToday || 0;
          
          const syncedBadge = document.getElementById('syncedBadge');
          const pendingBadge = document.getElementById('pendingBadge');
          const failedBadge = document.getElementById('failedBadge');
          const allBadge = document.getElementById('allBadge');
          
          if (syncedBadge) syncedBadge.textContent = syncedCount;
          if (pendingBadge) pendingBadge.textContent = pendingCount;
          if (failedBadge) failedBadge.textContent = failedCount;
          if (allBadge) allBadge.textContent = totalCount;
        }
      } catch (error) {
        console.error('Error updating order tabs:', error);
      }
    }
    
    function switchTab(tab) {
      currentTab = tab;
      currentPage = 1;
      
      // Update tab UI
      document.querySelectorAll('.order-tab').forEach(t => {
        t.classList.remove('border-primary', 'text-primary', 'font-semibold');
        t.classList.add('border-transparent', 'text-slate-500', 'dark:text-slate-400', 'font-medium');
      });
      
      const activeTab = document.getElementById(`tab-${tab}`);
      if (activeTab) {
        activeTab.classList.remove('border-transparent', 'text-slate-500', 'dark:text-slate-400', 'font-medium');
        activeTab.classList.add('border-primary', 'text-primary', 'font-semibold');
      }
      
      // Load orders with filter
      const statusMap = {
        'all': null,
        'synced': 'processed',
        'pending': 'pending_sync',
        'failed': 'failed'
      };
      
      loadOrders(1, statusMap[tab]);
    }
    
    function renderOrders(orders) {
      const ordersContainer = document.getElementById('ordersContainer');
      const showCheckboxes = currentSyncMode === 'manual';
      
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      function getStatusBadge(status, errorMessage) {
        if (status === 'processed') {
          return `<span class="inline-flex items-center px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[11px] font-semibold rounded-full">
            <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span> Synced
          </span>`;
        }
        if (status === 'pending_sync') {
          return `<span class="inline-flex items-center px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-[11px] font-semibold rounded-full">
            <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full mr-1.5"></span> Pending
          </span>`;
        }
        if (status === 'failed') {
          const hasError = errorMessage ? `
            <button class="text-[10px] text-blue-600 dark:text-blue-400 hover:underline mt-1 text-left" onclick="toggleErrorDetails('error-${orders.indexOf(orders.find(o => o.status === 'failed'))}')">Show details</button>
          ` : '';
          return `<div class="flex flex-col">
            <span class="inline-flex items-center px-2 py-0.5 w-fit bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-[11px] font-semibold rounded-full">
              <span class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5"></span> Failed
            </span>
            ${hasError}
          </div>`;
        }
        return `<span class="inline-flex items-center px-2 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-[11px] font-semibold rounded-full">${status}</span>`;
      }
      
      function getPaymentBadge(financialStatus) {
        if (!financialStatus) return '<span class="text-slate-400">—</span>';
        if (financialStatus === 'paid') {
          return `<span class="inline-flex items-center px-2 py-1 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-[10px] font-bold rounded border border-green-200 dark:border-green-900/50">
            <span class="material-icons-outlined text-[12px] mr-1">credit_card</span> PAID
          </span>`;
        }
        return `<span class="inline-flex items-center px-2 py-1 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400 text-[10px] font-bold rounded border border-amber-200 dark:border-amber-900/50">
          <span class="material-icons-outlined text-[12px] mr-1">payments</span> COD
        </span>`;
      }
      
      if (ordersContainer) {
        ordersContainer.innerHTML = orders.map((order, index) => {
          const hasError = order.status === 'failed' && order.errorMessage;
          return `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors group">
              ${showCheckboxes ? `<td class="px-6 py-4"><input type="checkbox" class="order-checkbox" value="${order.id}" ${(order.status === 'pending_sync' || order.status === 'failed') ? '' : 'disabled'} onchange="updateBulkActions()"></td>` : ''}
              <td class="px-6 py-4 font-semibold text-sm">#${order.shopifyOrderNumber || 'N/A'}</td>
              <td class="px-6 py-4 text-slate-600 dark:text-slate-400 text-sm whitespace-nowrap">${formatDate(order.createdAt)}</td>
              <td class="px-6 py-4 text-center">${getPaymentBadge(order.financialStatus)}</td>
              <td class="px-6 py-4">${getStatusBadge(order.status, order.errorMessage)}</td>
              <td class="px-6 py-4 font-mono text-xs text-slate-600 dark:text-slate-400">${order.delybellOrderId || '—'}</td>
              <td class="px-6 py-4 text-right">
                ${order.status === 'failed' ? `
                  <button class="inline-flex items-center px-3 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-semibold hover:border-primary hover:text-primary dark:hover:text-primary transition-all shadow-sm" onclick="retryOrder('${order.id}')">
                    <span class="material-icons-outlined text-sm mr-1">refresh</span> Retry
                  </button>
                ` : ''}
                ${order.status === 'pending_sync' && currentSyncMode === 'manual' ? `
                  <button class="inline-flex items-center px-3 py-1.5 bg-primary text-white rounded-md text-xs font-semibold hover:opacity-90 transition-opacity" onclick="syncSingleOrder('${order.id}')">
                    <span class="material-icons-outlined text-sm mr-1">sync</span> Sync
                  </button>
                ` : ''}
                ${order.status === 'processed' ? `
                  <button class="inline-flex items-center px-3 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-semibold text-slate-400 cursor-not-allowed opacity-50">
                    <span class="material-icons-outlined text-sm mr-1">visibility</span> View
                  </button>
                ` : ''}
              </td>
            </tr>
            ${hasError ? `
              <tr id="error-${index}" class="hidden">
                <td colspan="6" class="px-6 py-3 bg-red-50 dark:bg-red-900/10 border-l-4 border-red-500">
                  <div class="text-sm text-red-700 dark:text-red-400">${getFriendlyError(order.errorMessage)}</div>
                </td>
              </tr>
            ` : ''}
          `;
        }).join('');
      }
    }
    
    function toggleErrorDetails(id) {
      const row = document.getElementById(id);
      if (row) {
        row.classList.toggle('hidden');
      }
    }
    
    function updatePagination() {
      const paginationInfo = document.getElementById('paginationInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      if (paginationInfo) {
        if (totalOrders === 0) {
          paginationInfo.textContent = 'No orders';
        } else {
          const start = (currentPage - 1) * pageSize + 1;
          const end = Math.min(currentPage * pageSize, totalOrders);
          paginationInfo.textContent = `Showing ${start} to ${end} of ${totalOrders} orders`;
        }
      }
      
      if (prevBtn) {
        prevBtn.disabled = currentPage === 1;
        prevBtn.className = currentPage === 1
          ? 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-400 cursor-not-allowed text-sm'
          : 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm';
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentPage * pageSize >= totalOrders;
        nextBtn.className = currentPage * pageSize >= totalOrders
          ? 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-400 cursor-not-allowed text-sm'
          : 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm';
      }
    }
    
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox');
      if (selectAll) {
        const checked = selectAll.checked;
        document.querySelectorAll('.order-checkbox:not(:disabled)').forEach(cb => {
          cb.checked = checked;
        });
        updateBulkActions();
      }
    }
    
    function updateBulkActions() {
      const checked = document.querySelectorAll('.order-checkbox:checked').length;
      const bulkActions = document.getElementById('bulkActions');
      const bulkCount = document.getElementById('bulkCount');
      const bulkSyncBtn = document.getElementById('bulkSyncBtn');
      const bulkRetryBtn = document.getElementById('bulkRetryBtn');
      
      if (bulkActions) bulkActions.classList.toggle('hidden', checked === 0);
      if (bulkCount) bulkCount.textContent = `${checked} selected`;
      if (bulkSyncBtn) bulkSyncBtn.disabled = checked === 0;
      if (bulkRetryBtn) bulkRetryBtn.disabled = checked === 0;
    }
    
    async function syncSelectedOrders() {
      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        showToast('warning', 'No Selection', 'Please select at least one order');
        return;
      }
      
      showModal(
        'Sync Selected Orders',
        `Sync ${checked.length} selected order(s) to Delybell?`,
        async () => {
          try {
            const response = await fetch('/admin/api/orders/sync-selected', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderIds: checked }),
            });
            
            const data = await response.json();
            if (data.success) {
              showToast('success', 'Orders Synced', `Successfully synced ${data.synced} order(s). ${data.failed > 0 ? `${data.failed} failed.` : ''}`);
              loadOrders(currentPage);
              loadConnectionHealth();
              updateOrderTabs();
            } else {
              showToast('error', 'Sync Failed', data.error || 'Unknown error');
            }
          } catch (error) {
            showToast('error', 'Error', error.message);
          }
        }
      );
    }
    
    async function retryFailedOrders() {
      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        showToast('warning', 'No Selection', 'Please select at least one failed order');
        return;
      }
      
      showModal(
        'Retry Failed Orders',
        `Retry syncing ${checked.length} failed order(s)?`,
        async () => {
          try {
            const results = await Promise.all(
              checked.map(id => fetch(`/admin/api/orders/${id}/retry`, { method: 'POST' }))
            );
            
            let success = 0;
            let failed = 0;
            
            for (const result of results) {
              const data = await result.json();
              if (data.success) success++;
              else failed++;
            }
            
            showToast('success', 'Orders Retried', `Successfully retried ${success} order(s). ${failed > 0 ? `${failed} failed.` : ''}`);
            loadOrders(currentPage);
            loadConnectionHealth();
            updateOrderTabs();
          } catch (error) {
            showToast('error', 'Error', error.message);
          }
        }
      );
    }
    
    async function syncSingleOrder(orderId) {
      showModal(
        'Sync Order',
        'Sync this order to Delybell now?',
        async () => {
          try {
            const response = await fetch('/admin/api/orders/sync-selected', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderIds: [orderId] }),
            });
            
            const data = await response.json();
            if (data.success) {
              showToast('success', 'Order Synced', 'Order synced successfully!');
              loadOrders(currentPage);
              loadConnectionHealth();
              updateOrderTabs();
            } else {
              showToast('error', 'Sync Failed', data.error || 'Unknown error');
            }
          } catch (error) {
            showToast('error', 'Error', error.message);
          }
        }
      );
    }
    
    async function retryOrder(orderId) {
      showModal(
        'Retry Order',
        'Retry syncing this order?',
        async () => {
          try {
            const response = await fetch(`/admin/api/orders/${orderId}/retry`, { method: 'POST' });
            const data = await response.json();
            if (data.success) {
              showToast('success', 'Order Retried', 'Order retried successfully!');
              loadOrders(currentPage);
              loadConnectionHealth();
              updateOrderTabs();
            } else {
              showToast('error', 'Retry Failed', data.error || 'Unknown error');
            }
          } catch (error) {
            showToast('error', 'Error', error.message);
          }
        }
      );
    }
    
    // Load app status
    async function loadAppStatus() {
      const appContent = document.getElementById('app-content');
      
      try {
        if (!shop) {
          const urlParams = new URLSearchParams(window.location.search);
          shop = urlParams.get('shop') || urlParams.get('shopOrigin');
        }
        
        if (!shop) {
          window.location.href = '/';
          return;
        }
        
        const authResponse = await fetch(`/auth/check?shop=${encodeURIComponent(shop)}`);
        const authData = await authResponse.json();
        
        if (!authData.authenticated) {
          if (appContent) {
            appContent.innerHTML = `
              <div class="text-center py-20">
                <div class="mb-6">
                  <span class="material-icons-outlined text-6xl text-slate-400 mb-4">store</span>
                </div>
                <h2 class="text-xl font-bold mb-2">Installation Required</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-6">Please install the app to continue.</p>
                <a href="/auth/install?shop=${shop}" class="inline-block px-6 py-2 bg-primary text-white rounded font-medium hover:opacity-90 transition-opacity">Install App</a>
              </div>
            `;
          }
          return;
        }
        
        // Load sync mode first (defaults to manual)
        await loadSyncMode();
        
        // Load connection health
        const health = await loadConnectionHealth();
        
        // Render main app
        if (appContent) {
          appContent.innerHTML = `
            <!-- Health Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
              <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-light dark:border-border-dark flex items-center space-x-4">
                <div class="bg-green-100 dark:bg-green-900/30 p-2 rounded-lg">
                  <span class="material-icons-outlined text-green-600 dark:text-green-400">check_circle</span>
                </div>
                <div>
                  <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Shopify</p>
                  <p class="font-semibold">${health.shopify ? 'Connected' : 'Not Connected'}</p>
                </div>
              </div>
              <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-light dark:border-border-dark flex items-center space-x-4">
                <div class="bg-green-100 dark:bg-green-900/30 p-2 rounded-lg">
                  <span class="material-icons-outlined text-green-600 dark:text-green-400">check_circle</span>
                </div>
                <div>
                  <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Delybell</p>
                  <p class="font-semibold">${health.delybell ? 'Connected' : 'Not Connected'}</p>
                </div>
              </div>
              <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-light dark:border-border-dark flex items-center space-x-4">
                <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg">
                  <span class="material-icons-outlined text-blue-600 dark:text-blue-400">storefront</span>
                </div>
                <div class="overflow-hidden">
                  <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Store URL</p>
                  <p class="font-semibold truncate">${health.storeDomain || shop}</p>
                </div>
              </div>
              <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-light dark:border-border-dark flex items-center space-x-4">
                <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
                  <span class="material-icons-outlined text-slate-600 dark:text-slate-400">schedule</span>
                </div>
                <div>
                  <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Last Sync</p>
                  <p class="font-semibold">${health.lastSync || 'No syncs yet'}</p>
                </div>
              </div>
            </div>
            
            <!-- Sync Mode Card -->
            <div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark mb-8 overflow-hidden">
              <div class="px-6 py-4 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                <div class="flex items-center space-x-2">
                  <h2 class="font-semibold text-lg">Order Sync Mode</h2>
                  <span class="sync-mode-badge px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-bold uppercase rounded" id="syncModeBadge">Manual</span>
                </div>
                <div class="flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                  <button class="px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white" id="autoSyncBtn" onclick="updateSyncMode('auto')">Auto Sync</button>
                  <button class="px-4 py-1.5 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200" id="manualSyncBtn" onclick="updateSyncMode('manual')">Manual Sync</button>
                </div>
              </div>
              <div class="p-6">
                <div id="syncModeDescription"></div>
                <div id="manualSyncControls" class="hidden mt-4 flex items-center gap-3 flex-wrap">
                  <span class="text-sm text-slate-600 dark:text-slate-400" id="bulkCount">0 selected</span>
                  <button class="inline-flex items-center px-3 py-1.5 bg-primary text-white rounded-md text-xs font-semibold hover:opacity-90 transition-opacity" id="bulkSyncBtn" onclick="syncSelectedOrders()" disabled>
                    <span class="material-icons-outlined text-sm mr-1">sync</span> Sync Selected
                  </button>
                  <button class="inline-flex items-center px-3 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-semibold hover:border-primary hover:text-primary transition-all" id="bulkRetryBtn" onclick="retryFailedOrders()" disabled>
                    <span class="material-icons-outlined text-sm mr-1">refresh</span> Retry Failed
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Settings Card -->
            <div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark mb-8">
              <button class="w-full px-6 py-4 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group" onclick="toggleSettings()">
                <div class="flex items-center space-x-3">
                  <span class="material-icons-outlined text-slate-400 group-hover:text-primary transition-colors">settings</span>
                  <span class="font-semibold">Sync Settings</span>
                </div>
                <span class="material-icons-outlined text-slate-400" id="settingsIcon">expand_more</span>
              </button>
              <div id="settingsContent" class="hidden px-6 pb-6">
                <div class="text-slate-600 dark:text-slate-400 text-sm leading-relaxed space-y-2">
                  <p>Service type and payment settings are automatically configured based on your Shopify store settings.</p>
                  <p>Orders with pending payment are automatically marked as Cash on Delivery (COD) in Delybell.</p>
                </div>
              </div>
            </div>
            
            <!-- Orders Card -->
            <div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark overflow-hidden shadow-sm">
              <div class="p-6 border-b border-border-light dark:border-border-dark">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <h2 class="font-bold text-xl">Orders</h2>
                  <div class="flex flex-wrap items-center gap-3">
                    <button class="flex items-center gap-2 px-3 py-2 border border-border-light dark:border-border-dark rounded-md text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800" onclick="loadOrders(currentPage)">
                      <span class="material-icons-outlined text-sm">refresh</span>
                      Refresh
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Order Tabs -->
              <div class="flex items-center space-x-6 px-6 mt-6 border-b border-border-light dark:border-border-dark -mb-6">
                <button class="order-tab pb-3 border-b-2 border-primary text-primary font-semibold text-sm flex items-center space-x-2" id="tab-all" onclick="switchTab('all')">
                  <span>All Orders</span>
                  <span class="bg-primary/10 text-primary px-2 py-0.5 rounded-full text-[10px]" id="allBadge">0</span>
                </button>
                <button class="order-tab pb-3 border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-medium text-sm flex items-center space-x-2" id="tab-synced" onclick="switchTab('synced')">
                  <span>Synced</span>
                  <span class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-2 py-0.5 rounded-full text-[10px]" id="syncedBadge">0</span>
                </button>
                <button class="order-tab pb-3 border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-medium text-sm flex items-center space-x-2" id="tab-pending" onclick="switchTab('pending')">
                  <span>Pending</span>
                  <span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-500 px-2 py-0.5 rounded-full text-[10px]" id="pendingBadge">0</span>
                </button>
                <button class="order-tab pb-3 border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-medium text-sm flex items-center space-x-2" id="tab-failed" onclick="switchTab('failed')">
                  <span>Failed</span>
                  <span class="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-2 py-0.5 rounded-full text-[10px]" id="failedBadge">0</span>
                </button>
              </div>
              
              <!-- Bulk Actions -->
              <div id="bulkActions" class="hidden px-6 py-3 bg-slate-50 dark:bg-slate-800/50 border-b border-border-light dark:border-border-dark flex items-center gap-3 flex-wrap">
                <span class="text-sm text-slate-600 dark:text-slate-400" id="bulkCount2">0 selected</span>
                <button class="inline-flex items-center px-3 py-1.5 bg-primary text-white rounded-md text-xs font-semibold hover:opacity-90 transition-opacity" id="bulkSyncBtn2" onclick="syncSelectedOrders()" disabled>
                  <span class="material-icons-outlined text-sm mr-1">sync</span> Sync Selected
                </button>
                <button class="inline-flex items-center px-3 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-semibold hover:border-primary hover:text-primary transition-all" id="bulkRetryBtn2" onclick="retryFailedOrders()" disabled>
                  <span class="material-icons-outlined text-sm mr-1">refresh</span> Retry Failed
                </button>
              </div>
              
              <!-- Orders Table -->
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead>
                    <tr class="bg-slate-50 dark:bg-slate-800/50 text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      ${showCheckboxes ? '<th class="px-6 py-4"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>' : ''}
                      <th class="px-6 py-4">Order #</th>
                      <th class="px-6 py-4">Date</th>
                      <th class="px-6 py-4 text-center">Payment</th>
                      <th class="px-6 py-4">Sync Status</th>
                      <th class="px-6 py-4">Delybell Order ID</th>
                      <th class="px-6 py-4 text-right">Action</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border-light dark:divide-border-dark" id="ordersContainer">
                    <tr>
                      <td colspan="${showCheckboxes ? '7' : '6'}" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary mb-2"></div>
                        <div>Loading orders...</div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Pagination -->
              <div class="px-6 py-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between border-t border-border-light dark:border-border-dark">
                <span class="text-sm text-slate-500 dark:text-slate-400" id="paginationInfo">Loading...</span>
                <div class="flex space-x-2">
                  <button class="p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-400 cursor-not-allowed text-sm" id="prevPage" onclick="loadOrders(currentPage - 1)">Previous</button>
                  <button class="p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm" id="nextPage" onclick="loadOrders(currentPage + 1)">Next</button>
                </div>
              </div>
            </div>
          `;
          
          loadOrders(1);
          updateOrderTabs();
        }
      } catch (error) {
        console.error('[App] Error loading app status:', error);
        const appContent = document.getElementById('app-content');
        if (appContent) {
          appContent.innerHTML = `
            <div class="bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 rounded-lg p-6">
              <div class="flex items-start space-x-3">
                <span class="material-icons-outlined text-red-600 dark:text-red-400">error</span>
                <div>
                  <h3 class="font-semibold text-red-900 dark:text-red-300 mb-1">Error Loading App</h3>
                  <p class="text-red-800 dark:text-red-400/80 text-sm">${error.message}</p>
                </div>
              </div>
            </div>
          `;
        }
      }
    }
    
    // Fix bulk actions to use same IDs
    function updateBulkActions() {
      const checked = document.querySelectorAll('.order-checkbox:checked').length;
      const bulkActions = document.getElementById('bulkActions');
      const bulkCount = document.getElementById('bulkCount');
      const bulkCount2 = document.getElementById('bulkCount2');
      const bulkSyncBtn = document.getElementById('bulkSyncBtn');
      const bulkSyncBtn2 = document.getElementById('bulkSyncBtn2');
      const bulkRetryBtn = document.getElementById('bulkRetryBtn');
      const bulkRetryBtn2 = document.getElementById('bulkRetryBtn2');
      
      if (bulkActions) bulkActions.classList.toggle('hidden', checked === 0);
      if (bulkCount) bulkCount.textContent = `${checked} selected`;
      if (bulkCount2) bulkCount2.textContent = `${checked} selected`;
      if (bulkSyncBtn) bulkSyncBtn.disabled = checked === 0;
      if (bulkSyncBtn2) bulkSyncBtn2.disabled = checked === 0;
      if (bulkRetryBtn) bulkRetryBtn.disabled = checked === 0;
      if (bulkRetryBtn2) bulkRetryBtn2.disabled = checked === 0;
    }
    
    // Initialize
    console.log('[App] Page loaded, shop:', shop);
    loadAppStatus();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (shop) {
        loadConnectionHealth();
        loadOrders(currentPage);
        updateOrderTabs();
      }
    }, 30000);
  </script>
</body>
</html>
