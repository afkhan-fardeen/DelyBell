<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="shopify-api-key" content="<%= SHOPIFY_API_KEY %>">
  <title>Delybell Order Sync</title>
  
  <!-- Shopify App Bridge -->
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge-utils.js"></script>
  <script>
    window.SHOPIFY_API_KEY = '<%= SHOPIFY_API_KEY %>';
    window.SHOPIFY_SHOP = '<%= shop %>';
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #ffffff;
      color: #202223;
      line-height: 1.5;
      font-size: 14px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0;
    }
    
    .page-header {
      background: #ffffff;
      border-bottom: 1px solid #e1e3e5;
      padding: 20px 24px;
    }
    
    .page-title {
      font-size: 20px;
      font-weight: 600;
      color: #202223;
      margin-bottom: 4px;
      letter-spacing: -0.01em;
    }
    
    .page-subtitle {
      color: #6d7175;
      font-size: 14px;
      font-weight: 400;
    }
    
    .content {
      padding: 24px;
    }
    
    /* Connection & Health Section */
    .health-card {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-radius: 8px;
      margin-bottom: 20px;
      padding: 20px;
    }
    
    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .health-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f6f6f7;
      border-radius: 6px;
    }
    
    .health-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    
    .health-icon.success {
      color: #008060;
    }
    
    .health-icon.warning {
      color: #f59e0b;
    }
    
    .health-icon.error {
      color: #d72c0d;
    }
    
    .health-info {
      flex: 1;
    }
    
    .health-label {
      font-size: 12px;
      color: #6d7175;
      margin-bottom: 4px;
    }
    
    .health-value {
      font-size: 14px;
      font-weight: 500;
      color: #202223;
    }
    
    .health-meta {
      font-size: 12px;
      color: #6d7175;
      margin-top: 4px;
    }
    
    .warning-banner {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-left: 4px solid #f59e0b;
      border-radius: 6px;
      padding: 12px 16px;
      margin-top: 16px;
      display: none;
    }
    
    .warning-banner.active {
      display: block;
    }
    
    .warning-banner.error {
      background: #fee2e2;
      border-color: #d72c0d;
    }
    
    .warning-banner-content {
      display: flex;
      align-items: start;
      gap: 12px;
    }
    
    .warning-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    /* Sync Mode Control */
    .sync-mode-card {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-radius: 8px;
      margin-bottom: 20px;
      padding: 20px;
    }
    
    .sync-mode-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .sync-mode-title {
      font-size: 15px;
      font-weight: 600;
      color: #202223;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #c9cccf;
      transition: 0.3s;
      border-radius: 28px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #008060;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .sync-mode-description {
      font-size: 13px;
      color: #6d7175;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e1e3e5;
    }
    
    /* Orders Table */
    .orders-card {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .orders-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e1e3e5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .orders-title {
      font-size: 15px;
      font-weight: 600;
      color: #202223;
    }
    
    .orders-body {
      padding: 0;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .table thead {
      background: #f6f6f7;
    }
    
    .table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: #6d7175;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e1e3e5;
    }
    
    .table td {
      padding: 12px 16px;
      border-bottom: 1px solid #e1e3e5;
      color: #202223;
    }
    
    .table tbody tr:hover {
      background: #f6f6f7;
    }
    
    .table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .order-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .order-number {
      font-weight: 600;
      color: #202223;
    }
    
    .order-date {
      font-size: 13px;
      color: #6d7175;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 4px;
    }
    
    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .delybell-id {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 12px;
      color: #6d7175;
      background: #f6f6f7;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid;
      text-decoration: none;
      white-space: nowrap;
    }
    
    .button-primary {
      background: #008060;
      color: #ffffff;
      border-color: #008060;
    }
    
    .button-primary:hover:not(:disabled) {
      background: #006e52;
      border-color: #006e52;
    }
    
    .button-secondary {
      background: #ffffff;
      color: #202223;
      border-color: #e1e3e5;
    }
    
    .button-secondary:hover:not(:disabled) {
      background: #f6f6f7;
      border-color: #202223;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .button svg {
      width: 16px;
      height: 16px;
    }
    
    /* Bulk Actions */
    .bulk-actions {
      padding: 12px 20px;
      background: #f6f6f7;
      border-bottom: 1px solid #e1e3e5;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .bulk-actions.active {
      display: flex;
    }
    
    .bulk-actions-count {
      font-size: 13px;
      color: #202223;
      font-weight: 500;
    }
    
    /* Pagination */
    .pagination {
      padding: 16px 20px;
      border-top: 1px solid #e1e3e5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pagination-info {
      font-size: 13px;
      color: #6d7175;
    }
    
    .pagination-buttons {
      display: flex;
      gap: 8px;
    }
    
    .pagination-button {
      padding: 6px 12px;
      font-size: 13px;
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-radius: 6px;
      cursor: pointer;
      color: #202223;
    }
    
    .pagination-button:hover:not(:disabled) {
      background: #f6f6f7;
    }
    
    .pagination-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Error Details */
    .error-details {
      margin-top: 8px;
      padding: 8px 12px;
      background: #f6f6f7;
      border-radius: 4px;
      font-size: 12px;
      color: #6d7175;
      display: none;
    }
    
    .error-details.active {
      display: block;
    }
    
    .error-toggle {
      color: #008060;
      cursor: pointer;
      font-size: 12px;
      margin-top: 4px;
      text-decoration: underline;
    }
    
    .error-toggle:hover {
      color: #006e52;
    }
    
    /* Settings */
    .settings-card {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-radius: 8px;
      margin-bottom: 20px;
      padding: 20px;
    }
    
    .settings-item {
      padding: 16px 0;
      border-bottom: 1px solid #e1e3e5;
    }
    
    .settings-item:last-child {
      border-bottom: none;
    }
    
    .settings-label {
      font-size: 14px;
      font-weight: 500;
      color: #202223;
      margin-bottom: 8px;
    }
    
    .settings-description {
      font-size: 13px;
      color: #6d7175;
      margin-bottom: 12px;
    }
    
    .settings-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e1e3e5;
      border-radius: 6px;
      font-size: 14px;
      color: #202223;
    }
    
    .settings-input:focus {
      outline: none;
      border-color: #008060;
      box-shadow: 0 0 0 3px rgba(0, 128, 96, 0.1);
    }
    
    /* Loading & Empty States */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6d7175;
      font-size: 14px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e1e3e5;
      border-top-color: #008060;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6d7175;
    }
    
    .empty-state-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      color: #c9cccf;
    }
    
    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: #202223;
      margin-bottom: 8px;
    }
    
    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-left: 4px solid #d72c0d;
      padding: 16px 20px;
      margin-bottom: 20px;
      border-radius: 6px;
      color: #991b1b;
      font-size: 14px;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #ffffff;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      font-size: 18px;
      font-weight: 600;
      color: #202223;
      margin-bottom: 16px;
    }
    
    .modal-body {
      font-size: 14px;
      color: #6d7175;
      margin-bottom: 24px;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    @media (max-width: 768px) {
      .content {
        padding: 16px;
      }
      
      .page-header {
        padding: 16px;
      }
      
      .health-grid {
        grid-template-columns: 1fr;
      }
      
      .bulk-actions {
        flex-wrap: wrap;
      }
      
      .table {
        font-size: 12px;
      }
      
      .table th,
      .table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Delybell Order Sync</h1>
      <p class="page-subtitle">Simple delivery automation for Shopify</p>
    </div>
    
    <div class="content">
      <div id="error-container"></div>
      
      <div id="app-content">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div style="margin-top: 12px;">Loading...</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Confirm Action</div>
      <div class="modal-body" id="modalBody">Are you sure?</div>
      <div class="modal-actions">
        <button class="button button-secondary" onclick="closeModal()">Cancel</button>
        <button class="button button-primary" id="modalConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>
  
  <script>
    let app;
    let shop = window.SHOPIFY_SHOP || '<%= shop %>';
    const apiKey = window.SHOPIFY_API_KEY;
    let currentSyncMode = 'auto';
    let currentPage = 1;
    let pageSize = 20;
    let totalOrders = 0;
    
    // Initialize App Bridge
    if (apiKey && apiKey !== 'SHOPIFY_API_KEY_NOT_SET' && apiKey !== '<%= SHOPIFY_API_KEY %>') {
      try {
        if (window['app-bridge']) {
          const AppBridge = window['app-bridge'].default;
          const createApp = AppBridge.default;
          
          const appConfig = { apiKey: apiKey };
          if (shop) appConfig.shopOrigin = shop;
          
          window.app = createApp(appConfig);
          
          if (AppBridge.actions) {
            const TitleBar = AppBridge.actions.TitleBar;
            TitleBar.create(window.app, { title: 'Delybell Order Sync' });
          }
        }
      } catch (appBridgeError) {
        console.warn('App Bridge initialization failed:', appBridgeError);
      }
    }
    
    if (!shop) {
      const urlParams = new URLSearchParams(window.location.search);
      shop = urlParams.get('shop') || urlParams.get('shopOrigin');
    }
    
    // Human-readable error messages
    function getFriendlyError(errorMessage) {
      if (!errorMessage) return 'Unknown error occurred';
      
      const error = errorMessage.toLowerCase();
      
      if (error.includes('block') && error.includes('not found')) {
        return 'Address issue: Block not found. Ask customer to re-check address.';
      }
      if (error.includes('road') && error.includes('not found')) {
        return 'Address issue: Road not found. Order will sync with block only.';
      }
      if (error.includes('building') && error.includes('not found')) {
        return 'Address issue: Building not found. Order will sync without building.';
      }
      if (error.includes('validation')) {
        return 'Address validation failed. Please check customer address details.';
      }
      if (error.includes('network') || error.includes('timeout')) {
        return 'Connection issue: Unable to reach Delybell. Please try again.';
      }
      if (error.includes('authentication') || error.includes('unauthorized')) {
        return 'Authentication failed. Please contact support.';
      }
      
      return errorMessage.length > 100 ? errorMessage.substring(0, 100) + '...' : errorMessage;
    }
    
    // Modal functions
    function showModal(title, body, onConfirm) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').textContent = body;
      const confirmBtn = document.getElementById('modalConfirmBtn');
      confirmBtn.onclick = () => {
        onConfirm();
        closeModal();
      };
      document.getElementById('confirmModal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('confirmModal').classList.remove('active');
    }
    
    // Load connection health
    async function loadConnectionHealth() {
      if (!shop) return { shopify: false, delybell: false, lastSync: null };
      
      try {
        // Check Shopify connection
        const authResponse = await fetch(`/auth/check?shop=${encodeURIComponent(shop)}`);
        const authData = await authResponse.json();
        const shopifyConnected = authData.authenticated || false;
        
        // Check Delybell connection (try to get blocks)
        let delybellConnected = false;
        try {
          const blocksResponse = await fetch('/admin/api/delybell-health');
          if (blocksResponse.ok) {
            const blocksData = await blocksResponse.json();
            delybellConnected = blocksData.success || false;
          }
        } catch (e) {
          console.warn('Delybell health check failed:', e);
        }
        
        // Get last successful sync
        const statsResponse = await fetch(`/admin/api/stats?shop=${encodeURIComponent(shop)}`);
        const statsData = await statsResponse.json();
        const lastSync = statsData.success && statsData.stats.successfullySynced > 0 
          ? 'Just now' 
          : null;
        
        return {
          shopify: shopifyConnected,
          delybell: delybellConnected,
          lastSync: lastSync,
          storeDomain: shop
        };
      } catch (error) {
        console.error('Error loading connection health:', error);
        return { shopify: false, delybell: false, lastSync: null, storeDomain: shop };
      }
    }
    
    // Load sync mode
    async function loadSyncMode() {
      if (!shop) return;
      
      try {
        const response = await fetch(`/admin/api/shops/${encodeURIComponent(shop)}/sync-mode`);
        const data = await response.json();
        if (data.success) {
          currentSyncMode = data.sync_mode || 'auto';
          updateSyncModeUI();
        }
      } catch (error) {
        console.error('Error loading sync mode:', error);
      }
    }
    
    function updateSyncModeUI() {
      const toggle = document.getElementById('syncModeToggle');
      const description = document.getElementById('syncModeDescription');
      const manualControls = document.getElementById('manualSyncControls');
      
      if (toggle) toggle.checked = currentSyncMode === 'manual';
      if (description) {
        description.textContent = currentSyncMode === 'auto' 
          ? 'Orders sync automatically when created in Shopify.'
          : 'Orders are saved but not synced. Use bulk actions to sync manually.';
      }
      if (manualControls) {
        manualControls.classList.toggle('active', currentSyncMode === 'manual');
      }
      
      loadOrders();
    }
    
    async function updateSyncMode(mode) {
      if (!shop) {
        alert('Shop not detected');
        return;
      }
      
      try {
        const response = await fetch(`/admin/api/shops/${encodeURIComponent(shop)}/sync-mode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sync_mode: mode }),
        });
        
        const data = await response.json();
        if (data.success) {
          currentSyncMode = mode;
          updateSyncModeUI();
        } else {
          alert('Failed to update sync mode');
        }
      } catch (error) {
        console.error('Error updating sync mode:', error);
        alert('Error updating sync mode');
      }
    }
    
    // Load orders with pagination
    async function loadOrders(page = 1) {
      if (!shop) return;
      
      currentPage = page;
      const ordersContainer = document.getElementById('ordersContainer');
      const bulkActions = document.getElementById('bulkActions');
      
      if (ordersContainer) ordersContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div> Loading orders...</div>';
      
      try {
        const params = new URLSearchParams();
        params.append('shop', shop);
        params.append('limit', pageSize);
        params.append('offset', (page - 1) * pageSize);
        
        const response = await fetch(`/admin/api/orders?${params}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load orders');
        }
        
        const orders = data.orders || [];
        totalOrders = data.total || 0;
        
        if (orders.length === 0) {
          if (ordersContainer) {
            ordersContainer.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                  </svg>
                </div>
                <div class="empty-state-title">No orders yet</div>
                <div style="margin-top: 8px; font-size: 13px;">Orders will appear here once they are synced.</div>
              </div>
            `;
          }
          if (bulkActions) bulkActions.classList.remove('active');
          updatePagination();
          return;
        }
        
        renderOrders(orders);
        updatePagination();
      } catch (error) {
        console.error('Error loading orders:', error);
        if (ordersContainer) {
          ordersContainer.innerHTML = `
            <div class="error-message">
              <strong>Error loading orders</strong><br>
              ${error.message}
            </div>
          `;
        }
      }
    }
    
    function renderOrders(orders) {
      const ordersContainer = document.getElementById('ordersContainer');
      const showCheckboxes = currentSyncMode === 'manual';
      
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      function formatCurrency(amount, currency) {
        if (!amount && amount !== 0) return 'N/A';
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: currency || 'USD',
        }).format(parseFloat(amount));
      }
      
      function getStatusBadge(status) {
        if (status === 'processed') return '<span class="badge badge-success">‚úÖ Synced</span>';
        if (status === 'pending_sync') return '<span class="badge badge-warning">‚è≥ Pending</span>';
        if (status === 'failed') return '<span class="badge badge-error">‚ùå Failed</span>';
        return '<span class="badge badge-info">' + status + '</span>';
      }
      
      function getPaymentBadge(financialStatus) {
        if (!financialStatus) return '<span class="badge badge-info">-</span>';
        if (financialStatus === 'paid') return '<span class="badge badge-success">Paid</span>';
        return '<span class="badge badge-warning">COD</span>';
      }
      
      const canSelect = (status) => status === 'pending_sync' || status === 'failed';
      
      if (ordersContainer) {
        ordersContainer.innerHTML = `
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  ${showCheckboxes ? '<th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>' : ''}
                  <th>Order #</th>
                  <th>Date</th>
                  <th>Payment</th>
                  <th>Sync Status</th>
                  <th>Delybell Order ID</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${orders.map(order => {
                  const hasError = order.status === 'failed' && order.errorMessage;
                  return `
                    <tr>
                      ${showCheckboxes ? `<td><input type="checkbox" class="order-checkbox" value="${order.id}" ${canSelect(order.status) ? '' : 'disabled'} onchange="updateBulkActions()"></td>` : ''}
                      <td>
                        <div class="order-number">#${order.shopifyOrderNumber || 'N/A'}</div>
                      </td>
                      <td>
                        <div class="order-date">${formatDate(order.createdAt)}</div>
                      </td>
                      <td>${getPaymentBadge(order.financialStatus)}</td>
                      <td>
                        ${getStatusBadge(order.status)}
                        ${hasError ? `
                          <div class="error-details" id="error-${order.id}">
                            ${getFriendlyError(order.errorMessage)}
                          </div>
                          <div class="error-toggle" onclick="toggleErrorDetails('error-${order.id}')">Show details</div>
                        ` : ''}
                      </td>
                      <td>
                        ${order.delybellOrderId ? `<span class="delybell-id">${order.delybellOrderId}</span>` : '-'}
                      </td>
                      <td>
                        ${order.status === 'failed' ? `
                          <button class="button button-secondary" onclick="retryOrder('${order.id}')" title="Retry">
                            üîÅ Retry
                          </button>
                        ` : ''}
                        ${order.status === 'pending_sync' && currentSyncMode === 'manual' ? `
                          <button class="button button-primary" onclick="syncSingleOrder('${order.id}')" title="Sync now">
                            ‚úÖ Sync
                          </button>
                        ` : ''}
                        ${order.status === 'processed' ? `
                          <button class="button button-secondary" onclick="viewOrderDetails('${order.id}')" title="View details">
                            üëÅÔ∏è View
                          </button>
                        ` : ''}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
    }
    
    function toggleErrorDetails(id) {
      const details = document.getElementById(id);
      if (details) {
        details.classList.toggle('active');
        const toggle = details.nextElementSibling;
        if (toggle) {
          toggle.textContent = details.classList.contains('active') ? 'Hide details' : 'Show details';
        }
      }
    }
    
    function updatePagination() {
      const paginationInfo = document.getElementById('paginationInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      if (paginationInfo) {
        if (totalOrders === 0) {
          paginationInfo.textContent = 'No orders';
        } else {
          const start = (currentPage - 1) * pageSize + 1;
          const end = Math.min(currentPage * pageSize, totalOrders);
          paginationInfo.textContent = `Showing ${start}-${end} of ${totalOrders}`;
        }
      }
      
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage * pageSize >= totalOrders;
    }
    
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      document.querySelectorAll('.order-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = selectAll;
      });
      updateBulkActions();
    }
    
    function updateBulkActions() {
      const checked = document.querySelectorAll('.order-checkbox:checked').length;
      const bulkActions = document.getElementById('bulkActions');
      const bulkCount = document.getElementById('bulkCount');
      const bulkSyncBtn = document.getElementById('bulkSyncBtn');
      const bulkRetryBtn = document.getElementById('bulkRetryBtn');
      
      if (bulkActions) bulkActions.classList.toggle('active', checked > 0);
      if (bulkCount) bulkCount.textContent = `${checked} selected`;
      if (bulkSyncBtn) bulkSyncBtn.disabled = checked === 0;
      if (bulkRetryBtn) bulkRetryBtn.disabled = checked === 0;
    }
    
    async function syncSelectedOrders() {
      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) return;
      
      showModal(
        'Sync Selected Orders',
        `Sync ${checked.length} selected order(s) to Delybell?`,
        async () => {
          try {
            const response = await fetch('/admin/api/orders/sync-selected', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderIds: checked }),
            });
            
            const data = await response.json();
            if (data.success) {
              alert(`‚úÖ Synced ${data.synced} order(s) successfully. ${data.failed > 0 ? `${data.failed} failed.` : ''}`);
              loadOrders(currentPage);
              loadConnectionHealth();
            } else {
              alert('‚ùå Sync failed: ' + (data.error || 'Unknown error'));
            }
          } catch (error) {
            alert('‚ùå Error: ' + error.message);
          }
        }
      );
    }
    
    async function retryFailedOrders() {
      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) return;
      
      showModal(
        'Retry Failed Orders',
        `Retry syncing ${checked.length} failed order(s)?`,
        async () => {
          try {
            const results = await Promise.all(
              checked.map(id => fetch(`/admin/api/orders/${id}/retry`, { method: 'POST' }))
            );
            
            let success = 0;
            let failed = 0;
            
            for (const result of results) {
              const data = await result.json();
              if (data.success) success++;
              else failed++;
            }
            
            alert(`‚úÖ Retried ${success} order(s) successfully. ${failed > 0 ? `${failed} failed.` : ''}`);
            loadOrders(currentPage);
            loadConnectionHealth();
          } catch (error) {
            alert('‚ùå Error: ' + error.message);
          }
        }
      );
    }
    
    async function syncSingleOrder(orderId) {
      showModal(
        'Sync Order',
        'Sync this order to Delybell now?',
        async () => {
          try {
            const response = await fetch('/admin/api/orders/sync-selected', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderIds: [orderId] }),
            });
            
            const data = await response.json();
            if (data.success) {
              alert('‚úÖ Order synced successfully!');
              loadOrders(currentPage);
              loadConnectionHealth();
            } else {
              alert('‚ùå Sync failed: ' + (data.error || 'Unknown error'));
            }
          } catch (error) {
            alert('‚ùå Error: ' + error.message);
          }
        }
      );
    }
    
    async function retryOrder(orderId) {
      showModal(
        'Retry Order',
        'Retry syncing this order?',
        async () => {
          try {
            const response = await fetch(`/admin/api/orders/${orderId}/retry`, { method: 'POST' });
            const data = await response.json();
            if (data.success) {
              alert('‚úÖ Order retried successfully!');
              loadOrders(currentPage);
              loadConnectionHealth();
            } else {
              alert('‚ùå Retry failed: ' + (data.error || 'Unknown error'));
            }
          } catch (error) {
            alert('‚ùå Error: ' + error.message);
          }
        }
      );
    }
    
    async function viewOrderDetails(orderId) {
      try {
        const response = await fetch(`/admin/api/orders/${orderId}`);
        const data = await response.json();
        if (data.success) {
          const order = data.order;
          const details = `
Order #${order.shopifyOrderNumber || 'N/A'}
Amount: ${order.currency || 'USD'} ${order.amount || '0.00'}
Status: ${order.status}
Delybell ID: ${order.delybellOrderId || 'Not synced'}
Synced At: ${order.syncedAt || 'Not synced'}
${order.errorMessage ? `Error: ${getFriendlyError(order.errorMessage)}` : ''}
          `.trim();
          showModal('Order Details', details, () => {});
        }
      } catch (error) {
        alert('Error loading order details: ' + error.message);
      }
    }
    
    // Load app status
    async function loadAppStatus() {
      const appContent = document.getElementById('app-content');
      
      try {
        if (!shop) {
          const urlParams = new URLSearchParams(window.location.search);
          shop = urlParams.get('shop') || urlParams.get('shopOrigin');
        }
        
        if (!shop) {
          window.location.href = '/';
          return;
        }
        
        const authResponse = await fetch(`/auth/check?shop=${encodeURIComponent(shop)}`);
        const authData = await authResponse.json();
        
        if (!authData.authenticated) {
          if (appContent) {
            appContent.innerHTML = `
              <div class="health-card">
                <div style="text-align: center; padding: 40px 20px;">
                  <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Installation Required</div>
                  <div style="font-size: 14px; color: #6d7175; margin-bottom: 24px;">Please install the app to continue.</div>
                  <a href="/auth/install?shop=${shop}" class="button button-primary">Install App</a>
                </div>
              </div>
            `;
          }
          return;
        }
        
        // Load sync mode first
        await loadSyncMode();
        
        // Load connection health
        const health = await loadConnectionHealth();
        
        // Render main app
        if (appContent) {
          appContent.innerHTML = `
            <!-- Connection & Health -->
            <div class="health-card">
              <div class="health-grid">
                <div class="health-item">
                  <svg class="health-icon ${health.shopify ? 'success' : 'error'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="health-info">
                    <div class="health-label">Shopify</div>
                    <div class="health-value">${health.shopify ? '‚úÖ Connected' : '‚ùå Not Connected'}</div>
                  </div>
                </div>
                <div class="health-item">
                  <svg class="health-icon ${health.delybell ? 'success' : 'error'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="health-info">
                    <div class="health-label">Delybell</div>
                    <div class="health-value">${health.delybell ? '‚úÖ Connected' : '‚ùå Not Connected'}</div>
                  </div>
                </div>
                <div class="health-item">
                  <svg class="health-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                  <div class="health-info">
                    <div class="health-label">Store Domain</div>
                    <div class="health-value">${health.storeDomain || shop}</div>
                  </div>
                </div>
                <div class="health-item">
                  <svg class="health-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="health-info">
                    <div class="health-label">Last Sync</div>
                    <div class="health-value">${health.lastSync || 'No syncs yet'}</div>
                  </div>
                </div>
              </div>
              <div class="warning-banner" id="warningBanner"></div>
            </div>
            
            <!-- Sync Mode Control -->
            <div class="sync-mode-card">
              <div class="sync-mode-header">
                <div class="sync-mode-title">Sync Mode</div>
                <label class="toggle-switch">
                  <input type="checkbox" id="syncModeToggle" onchange="updateSyncMode(this.checked ? 'manual' : 'auto')">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="sync-mode-description" id="syncModeDescription">
                Orders sync automatically when created in Shopify.
              </div>
            </div>
            
            <!-- Orders List -->
            <div class="orders-card">
              <div class="orders-header">
                <div class="orders-title">Orders</div>
                <button class="button button-secondary" onclick="loadOrders(currentPage)">
                  üîÅ Refresh
                </button>
              </div>
              <div class="bulk-actions" id="bulkActions">
                <span class="bulk-actions-count" id="bulkCount">0 selected</span>
                <button class="button button-primary" id="bulkSyncBtn" onclick="syncSelectedOrders()" disabled>
                  ‚úÖ Sync Selected
                </button>
                <button class="button button-secondary" id="bulkRetryBtn" onclick="retryFailedOrders()" disabled>
                  üîÅ Retry Failed
                </button>
              </div>
              <div class="orders-body">
                <div id="ordersContainer">
                  <div class="loading">Loading orders...</div>
                </div>
              </div>
              <div class="pagination">
                <div class="pagination-info" id="paginationInfo">Loading...</div>
                <div class="pagination-buttons">
                  <button class="pagination-button" id="prevPage" onclick="loadOrders(currentPage - 1)">‚Üê Previous</button>
                  <button class="pagination-button" id="nextPage" onclick="loadOrders(currentPage + 1)">Next ‚Üí</button>
                </div>
              </div>
            </div>
            
            <!-- Settings -->
            <div class="settings-card">
              <div class="settings-title" style="font-size: 15px; font-weight: 600; margin-bottom: 16px;">Settings</div>
              <div class="settings-item">
                <div class="settings-label">Auto-retry Failed Orders</div>
                <div class="settings-description">Automatically retry failed orders (coming soon)</div>
                <label class="toggle-switch">
                  <input type="checkbox" disabled>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          `;
          
          loadOrders(1);
        }
      } catch (error) {
        console.error('[App] Error loading app status:', error);
        const appContent = document.getElementById('app-content');
        if (appContent) {
          appContent.innerHTML = `
            <div class="error-message">
              <strong>Error Loading App</strong><br>
              ${error.message}
            </div>
          `;
        }
      }
    }
    
    // Initialize
    console.log('[App] Page loaded, shop:', shop);
    loadAppStatus();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (shop) {
        loadConnectionHealth();
        loadOrders(currentPage);
      }
    }, 30000);
  </script>
</body>
</html>
