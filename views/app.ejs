<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="shopify-api-key" content="<%= SHOPIFY_API_KEY %>">
  <title>Delybell Order Sync</title>
  
  <!-- Shopify App Bridge -->
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge-utils.js"></script>
  <script>
    window.SHOPIFY_API_KEY = '<%= SHOPIFY_API_KEY %>';
    window.SHOPIFY_SHOP = '<%= shop %>';
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f6f6f7;
      color: #202223;
      line-height: 1.5;
      font-size: 14px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0;
    }
    
    .page-header {
      background: #ffffff;
      border-bottom: 1px solid #e1e3e5;
      padding: 20px 24px;
    }
    
    .page-title {
      font-size: 20px;
      font-weight: 600;
      color: #202223;
      margin-bottom: 4px;
      letter-spacing: -0.01em;
    }
    
    .page-subtitle {
      color: #6d7175;
      font-size: 14px;
      font-weight: 400;
    }
    
    .content {
      padding: 24px;
    }
    
    .card {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
    }
    
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e1e3e5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #202223;
    }
    
    .card-body {
      padding: 20px;
    }
    
    /* Sync Mode Toggle */
    .sync-mode-section {
      background: linear-gradient(135deg, #f6f6f7 0%, #ffffff 100%);
      border-left: 4px solid #008060;
    }
    
    .sync-mode-toggle {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .toggle-option {
      flex: 1;
      position: relative;
    }
    
    .toggle-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-option label {
      display: block;
      padding: 16px;
      border: 2px solid #e1e3e5;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #ffffff;
      text-align: center;
    }
    
    .toggle-option input[type="radio"]:checked + label {
      border-color: #008060;
      background: #f0fdf4;
      box-shadow: 0 0 0 3px rgba(0, 128, 96, 0.1);
    }
    
    .toggle-option label .toggle-title {
      font-size: 14px;
      font-weight: 600;
      color: #202223;
      margin-bottom: 4px;
    }
    
    .toggle-option input[type="radio"]:checked + label .toggle-title {
      color: #008060;
    }
    
    .toggle-option label .toggle-description {
      font-size: 12px;
      color: #6d7175;
      margin-top: 4px;
    }
    
    .toggle-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #008060;
      color: #ffffff;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 3px;
      margin-left: 8px;
    }
    
    .sync-mode-help {
      margin-top: 16px;
      padding: 12px 16px;
      background: #f6f6f7;
      border-radius: 6px;
      font-size: 13px;
      color: #6d7175;
      display: flex;
      align-items: start;
      gap: 12px;
    }
    
    .sync-mode-help svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      margin-top: 2px;
      color: #6d7175;
    }
    
    .manual-sync-controls {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e1e3e5;
      display: none;
    }
    
    .manual-sync-controls.active {
      display: block;
    }
    
    .manual-sync-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid;
      text-decoration: none;
      white-space: nowrap;
    }
    
    .button-primary {
      background: #008060;
      color: #ffffff;
      border-color: #008060;
    }
    
    .button-primary:hover:not(:disabled) {
      background: #006e52;
      border-color: #006e52;
    }
    
    .button-secondary {
      background: #ffffff;
      color: #202223;
      border-color: #e1e3e5;
    }
    
    .button-secondary:hover:not(:disabled) {
      background: #f6f6f7;
      border-color: #202223;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .button svg {
      width: 16px;
      height: 16px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-radius: 8px;
      padding: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: #008060;
    }
    
    .stat-card.success::before {
      background: #008060;
    }
    
    .stat-card.warning::before {
      background: #f59e0b;
    }
    
    .stat-card.error::before {
      background: #d72c0d;
    }
    
    .stat-label {
      font-size: 12px;
      font-weight: 500;
      color: #6d7175;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #202223;
      line-height: 1.2;
    }
    
    /* Table */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .table thead {
      background: #f6f6f7;
    }
    
    .table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: #6d7175;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e1e3e5;
    }
    
    .table td {
      padding: 12px 16px;
      border-bottom: 1px solid #e1e3e5;
      color: #202223;
    }
    
    .table tbody tr:hover {
      background: #f6f6f7;
    }
    
    .table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .order-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .order-number {
      font-weight: 600;
      color: #202223;
    }
    
    .order-meta {
      font-size: 12px;
      color: #6d7175;
      margin-top: 4px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 4px;
      text-transform: capitalize;
    }
    
    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .delybell-id {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 12px;
      color: #6d7175;
      background: #f6f6f7;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .link {
      color: #008060;
      text-decoration: none;
      font-weight: 500;
    }
    
    .link:hover {
      text-decoration: underline;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6d7175;
      font-size: 14px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e1e3e5;
      border-top-color: #008060;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6d7175;
    }
    
    .empty-state-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      color: #c9cccf;
    }
    
    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: #202223;
      margin-bottom: 8px;
    }
    
    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-left: 4px solid #d72c0d;
      padding: 16px 20px;
      margin-bottom: 20px;
      border-radius: 6px;
      color: #991b1b;
      font-size: 14px;
    }
    
    .info-section {
      background: #f6f6f7;
      border-radius: 6px;
      padding: 16px;
      margin-top: 20px;
    }
    
    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .info-list li {
      padding: 8px 0;
      font-size: 13px;
      color: #6d7175;
      border-bottom: 1px solid #e1e3e5;
    }
    
    .info-list li:last-child {
      border-bottom: none;
    }
    
    .info-list li:before {
      content: "â€¢";
      color: #008060;
      margin-right: 12px;
      font-weight: bold;
    }
    
    .count {
      color: #6d7175;
      font-size: 12px;
      font-weight: 400;
      margin-left: 8px;
    }
    
    @media (max-width: 768px) {
      .content {
        padding: 16px;
      }
      
      .page-header {
        padding: 16px;
      }
      
      .card-body {
        padding: 16px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .sync-mode-toggle {
        flex-direction: column;
      }
      
      .manual-sync-buttons {
        flex-direction: column;
      }
      
      .manual-sync-buttons .button {
        width: 100%;
      }
      
      .table {
        font-size: 12px;
      }
      
      .table th,
      .table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Delybell Order Sync</h1>
      <p class="page-subtitle">Automatically sync your Shopify orders to Delybell delivery management system</p>
    </div>
    
    <div class="content">
      <div id="error-container"></div>
      
      <div id="app-content">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div style="margin-top: 12px;">Loading app status...</div>
          <div style="font-size: 12px; color: #6d7175; margin-top: 8px;" id="loading-details">Initializing...</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let app;
    let shop = window.SHOPIFY_SHOP || '<%= shop %>';
    const apiKey = window.SHOPIFY_API_KEY;
    let currentSyncMode = 'auto';
    
    // Initialize App Bridge
    if (apiKey && apiKey !== 'SHOPIFY_API_KEY_NOT_SET' && apiKey !== '<%= SHOPIFY_API_KEY %>') {
      try {
        if (window['app-bridge']) {
          const AppBridge = window['app-bridge'].default;
          const createApp = AppBridge.default;
          
          const appConfig = {
            apiKey: apiKey,
          };
          
          if (shop) {
            appConfig.shopOrigin = shop;
          }
          
          window.app = createApp(appConfig);
          
          if (!shop && window.app && window.app.getState) {
            try {
              const state = window.app.getState();
              if (state && state.shop) {
                shop = state.shop;
                console.log('[App] Got shop from App Bridge state:', shop);
              }
            } catch (e) {
              console.warn('[App] Could not get shop from App Bridge state:', e);
            }
          }
          
          if (AppBridge.actions) {
            const TitleBar = AppBridge.actions.TitleBar;
            TitleBar.create(window.app, {
              title: 'Delybell Order Sync',
            });
          }
        }
      } catch (appBridgeError) {
        console.warn('App Bridge initialization failed:', appBridgeError);
      }
    }
    
    if (!shop) {
      const urlParams = new URLSearchParams(window.location.search);
      shop = urlParams.get('shop') || urlParams.get('shopOrigin');
      if (shop) {
        console.log('[App] Got shop from URL params:', shop);
      }
    }
    
    console.log('[App] Final shop value:', shop || 'NOT DETECTED');
    
    // Load sync mode
    async function loadSyncMode() {
      if (!shop) return;
      
      try {
        const response = await fetch(`/admin/api/shops/${encodeURIComponent(shop)}/sync-mode`);
        const data = await response.json();
        if (data.success) {
          currentSyncMode = data.sync_mode || 'auto';
          updateSyncModeUI();
        }
      } catch (error) {
        console.error('Error loading sync mode:', error);
      }
    }
    
    function updateSyncModeUI() {
      const autoRadio = document.getElementById('syncModeAuto');
      const manualRadio = document.getElementById('syncModeManual');
      const manualControls = document.getElementById('manualSyncControls');
      
      if (autoRadio) autoRadio.checked = currentSyncMode === 'auto';
      if (manualRadio) manualRadio.checked = currentSyncMode === 'manual';
      if (manualControls) {
        manualControls.classList.toggle('active', currentSyncMode === 'manual');
      }
      
      loadOrders();
    }
    
    async function updateSyncMode(mode) {
      if (!shop) {
        alert('Shop not detected');
        return;
      }
      
      try {
        const response = await fetch(`/admin/api/shops/${encodeURIComponent(shop)}/sync-mode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sync_mode: mode }),
        });
        
        const data = await response.json();
        if (data.success) {
          currentSyncMode = mode;
          updateSyncModeUI();
        } else {
          alert('Failed to update sync mode: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error updating sync mode:', error);
        alert('Error updating sync mode: ' + error.message);
      }
    }
    
    async function syncSelectedOrders() {
      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        alert('Please select at least one order');
        return;
      }
      
      if (!confirm(`Sync ${checked.length} selected order(s)?`)) return;
      
      const btn = document.getElementById('syncSelectedBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner"></div> Syncing...';
      
      try {
        const response = await fetch('/admin/api/orders/sync-selected', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderIds: checked }),
        });
        
        const data = await response.json();
        if (data.success) {
          alert(`Synced ${data.synced} order(s) successfully. ${data.failed > 0 ? `${data.failed} failed.` : ''}`);
          loadOrders();
          loadStats();
        } else {
          alert('Sync failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error syncing orders:', error);
        alert('Error syncing orders: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    async function syncAllPendingOrders() {
      if (!confirm('Sync all pending orders?')) return;
      
      const btn = document.getElementById('syncAllBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner"></div> Syncing...';
      
      try {
        const url = `/admin/api/orders/sync-all?shop=${encodeURIComponent(shop)}`;
        const response = await fetch(url, { method: 'POST' });
        
        const data = await response.json();
        if (data.success) {
          alert(`Synced ${data.synced} order(s) successfully. ${data.failed > 0 ? `${data.failed} failed.` : ''}`);
          loadOrders();
          loadStats();
        } else {
          alert('Sync failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error syncing all orders:', error);
        alert('Error syncing orders: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    function updateSyncButtons() {
      const checked = document.querySelectorAll('.order-checkbox:checked').length;
      const btn = document.getElementById('syncSelectedBtn');
      if (btn) btn.disabled = checked === 0;
    }
    
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      document.querySelectorAll('.order-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = selectAll;
      });
      updateSyncButtons();
    }
    
    // Load app status
    async function loadAppStatus() {
      const loadingDetails = document.getElementById('loading-details');
      
      try {
        if (!shop && window.app) {
          console.log('[App] Waiting for App Bridge to initialize...');
          await new Promise(resolve => setTimeout(resolve, 500));
          
          if (window.app && window.app.getState) {
            try {
              const state = window.app.getState();
              if (state && state.shop) {
                shop = state.shop;
                console.log('[App] Got shop from App Bridge state (after wait):', shop);
              }
            } catch (e) {
              console.warn('[App] Could not get shop from App Bridge state:', e);
            }
          }
        }
        
        if (loadingDetails) {
          loadingDetails.textContent = shop ? `Checking authentication for ${shop}...` : 'Detecting shop domain...';
        }
        
        if (!shop) {
          console.error('[App] No shop detected after all attempts, redirecting to install page');
          window.location.href = '/';
          return;
        }
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
        }, 5000);
        
        let authResponse;
        try {
          authResponse = await fetch(`/auth/check?shop=${encodeURIComponent(shop)}`, {
            signal: controller.signal,
            headers: { 'Accept': 'application/json' }
          });
          clearTimeout(timeoutId);
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            throw new Error('Request timed out');
          }
          throw fetchError;
        }
        
        if (!authResponse.ok) {
          throw new Error(`Auth check failed: ${authResponse.status}`);
        }
        
        const authData = await authResponse.json();
        
        if (loadingDetails) {
          loadingDetails.textContent = authData.authenticated 
            ? `App is installed and ready` 
            : `App needs to be installed`;
        }
        
        const appContent = document.getElementById('app-content');
        
        if (authData.authenticated) {
          if (loadingDetails) loadingDetails.textContent = '';
          
          // Load sync mode first
          await loadSyncMode();
          
          appContent.innerHTML = `
            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
              <div class="stat-card success">
                <div class="stat-label">Total Orders</div>
                <div class="stat-value" id="totalOrders">-</div>
              </div>
              <div class="stat-card success">
                <div class="stat-label">Synced</div>
                <div class="stat-value" id="syncedOrders">-</div>
              </div>
              <div class="stat-card warning">
                <div class="stat-label">Pending</div>
                <div class="stat-value" id="pendingOrders">-</div>
              </div>
              <div class="stat-card error">
                <div class="stat-label">Failed</div>
                <div class="stat-value" id="failedOrders">-</div>
              </div>
            </div>
            
            <!-- Sync Mode -->
            <div class="card sync-mode-section">
              <div class="card-header">
                <div class="card-title">Order Sync Mode</div>
              </div>
              <div class="card-body">
                <div class="sync-mode-toggle">
                  <div class="toggle-option">
                    <input type="radio" name="syncMode" value="auto" id="syncModeAuto" onchange="updateSyncMode('auto')">
                    <label for="syncModeAuto">
                      <div class="toggle-title">Live Sync <span class="toggle-badge">Recommended</span></div>
                      <div class="toggle-description">Orders sync automatically when created</div>
                    </label>
                  </div>
                  <div class="toggle-option">
                    <input type="radio" name="syncMode" value="manual" id="syncModeManual" onchange="updateSyncMode('manual')">
                    <label for="syncModeManual">
                      <div class="toggle-title">Manual Sync</div>
                      <div class="toggle-description">Choose which orders to sync and when</div>
                    </label>
                  </div>
                </div>
                
                <div class="sync-mode-help">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div>
                    <strong>Manual Sync Mode:</strong> Orders will be saved but not automatically synced to Delybell. Use the controls below to sync orders manually when ready.
                  </div>
                </div>
                
                <div class="manual-sync-controls" id="manualSyncControls">
                  <div class="manual-sync-buttons">
                    <button class="button button-primary" id="syncSelectedBtn" onclick="syncSelectedOrders()" disabled>
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                      Sync Selected
                    </button>
                    <button class="button button-secondary" id="syncAllBtn" onclick="syncAllPendingOrders()">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                      Sync All Pending
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Orders -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">Orders <span class="count" id="orders-count"></span></div>
                <button class="button button-secondary" id="refresh-orders" onclick="loadOrders()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Refresh
                </button>
              </div>
              <div class="card-body">
                <div id="orders-container">
                  <div class="loading">Loading orders...</div>
                </div>
              </div>
            </div>
            
            <!-- Info -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">How It Works</div>
              </div>
              <div class="card-body">
                <ul class="info-list">
                  <li>Orders are automatically synced to Delybell based on your sync mode setting</li>
                  <li>Webhooks are registered and active - no manual action required for Live Sync mode</li>
                  <li>Synced orders appear in the table above with Delybell order IDs</li>
                  <li>Tracking information is automatically updated when available</li>
                  <li>All order processing is handled automatically in the background</li>
                </ul>
              </div>
            </div>
          `;
          
          loadStats();
          loadOrders();
        } else {
          if (loadingDetails) loadingDetails.textContent = '';
          
          appContent.innerHTML = `
            <div class="card">
              <div class="card-header">
                <div class="card-title">Installation Required</div>
              </div>
              <div class="card-body">
                <div style="margin-bottom: 24px;">
                  <div style="font-size: 12px; color: #6d7175; margin-bottom: 8px;">Installation Status</div>
                  <span class="badge badge-warning">Not Installed</span>
                </div>
                <div style="margin-bottom: 24px;">
                  <div style="font-size: 12px; color: #6d7175; margin-bottom: 8px;">Shop</div>
                  <div style="font-size: 14px; color: #202223;">${shop}</div>
                </div>
                <a href="/auth/install?shop=${shop}" class="button button-primary" style="width: 100%; text-align: center; display: block;">Install App</a>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('[App] Error loading app status:', error);
        
        const errorContainer = document.getElementById('error-container');
        const appContent = document.getElementById('app-content');
        
        if (errorContainer) {
          errorContainer.innerHTML = `
            <div class="error-message">
              <strong>Error Loading App Status</strong><br>
              ${error.message}
            </div>
          `;
        }
        
        if (appContent) {
          appContent.innerHTML = `
            <div class="card">
              <div class="card-header">
                <div class="card-title">Error</div>
              </div>
              <div class="card-body">
                <p style="color: #6d7175; margin-bottom: 16px;">Unable to load app status. Error: ${error.message}</p>
                <button onclick="loadAppStatus()" class="button button-primary">Retry</button>
              </div>
            </div>
          `;
        }
      }
    }
    
    async function loadStats() {
      if (!shop) return;
      
      try {
        const response = await fetch(`/admin/api/stats?shop=${encodeURIComponent(shop)}`);
        const data = await response.json();
        if (data.success) {
          document.getElementById('totalOrders').textContent = data.stats.totalOrdersToday || 0;
          document.getElementById('syncedOrders').textContent = data.stats.successfullySynced || 0;
          document.getElementById('pendingOrders').textContent = data.stats.pendingSync || 0;
          document.getElementById('failedOrders').textContent = data.stats.failed || 0;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    async function loadOrders() {
      if (!shop) return;
      
      try {
        const refreshButton = document.getElementById('refresh-orders');
        const ordersContainer = document.getElementById('orders-container');
        const ordersCount = document.getElementById('orders-count');
        
        if (refreshButton) refreshButton.disabled = true;
        if (ordersContainer) ordersContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div> Loading orders...</div>';
        
        // Load orders for this shop
        const params = new URLSearchParams();
        params.append('shop', shop);
        params.append('limit', '50');
        
        const response = await fetch(`/admin/api/orders?${params}`);
        const data = await response.json();
        
        if (refreshButton) refreshButton.disabled = false;
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load orders');
        }
        
        const orders = data.orders || [];
        
        if (ordersCount) {
          ordersCount.textContent = `(${orders.length})`;
        }
        
        if (orders.length === 0) {
          if (ordersContainer) {
            ordersContainer.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                  </svg>
                </div>
                <div class="empty-state-title">No orders yet</div>
                <div style="margin-top: 8px; font-size: 13px; color: #6d7175;">Orders will appear here once they are synced to Delybell.</div>
              </div>
            `;
          }
          return;
        }
        
        function formatDate(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }
        
        function formatCurrency(amount, currency) {
          if (!amount && amount !== 0) return 'N/A';
          const currencyCode = currency || 'USD';
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: currencyCode,
          }).format(parseFloat(amount));
        }
        
        function getStatusBadge(status) {
          if (status === 'processed') return '<span class="badge badge-success">Synced</span>';
          if (status === 'pending_sync') return '<span class="badge badge-warning">Pending Sync</span>';
          if (status === 'failed') return '<span class="badge badge-error">Failed</span>';
          return '<span class="badge badge-info">' + status + '</span>';
        }
        
        const showCheckboxes = currentSyncMode === 'manual';
        const canSelect = (status) => status === 'pending_sync' || status === 'failed';
        
        if (ordersContainer) {
          ordersContainer.innerHTML = `
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    ${showCheckboxes ? '<th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>' : ''}
                    <th>Order #</th>
                    <th>Amount</th>
                    <th>Payment</th>
                    <th>Delybell Order ID</th>
                    <th>Status</th>
                    <th>Synced At</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  ${orders.map(order => `
                    <tr>
                      ${showCheckboxes ? `<td><input type="checkbox" class="order-checkbox" value="${order.id}" ${canSelect(order.status) ? '' : 'disabled'} onchange="updateSyncButtons()"></td>` : ''}
                      <td>
                        <div class="order-number">#${order.shopifyOrderNumber || 'N/A'}</div>
                        <div class="order-meta">${order.shop || ''}</div>
                      </td>
                      <td>${formatCurrency(order.amount, order.currency)}</td>
                      <td>
                        ${order.financialStatus === 'paid' ? '<span class="badge badge-success">Paid</span>' : '<span class="badge badge-warning">COD</span>'}
                      </td>
                      <td>
                        ${order.delybellOrderId ? `<span class="delybell-id">${order.delybellOrderId}</span>` : '<span style="color: #999999;">-</span>'}
                      </td>
                      <td>${getStatusBadge(order.status)}</td>
                      <td style="font-size: 12px; color: #6d7175;">${formatDate(order.syncedAt || order.createdAt)}</td>
                      <td>
                        ${order.status === 'failed' ? `<button class="button button-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="retryOrder('${order.id}')">Retry</button>` : ''}
                        ${order.status === 'pending_sync' && currentSyncMode === 'manual' ? `<button class="button button-primary" style="padding: 6px 12px; font-size: 12px;" onclick="syncSingleOrder('${order.id}')">Sync Now</button>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      } catch (error) {
        console.error('[App] Error loading orders:', error);
        const ordersContainer = document.getElementById('orders-container');
        const refreshButton = document.getElementById('refresh-orders');
        
        if (refreshButton) refreshButton.disabled = false;
        
        if (ordersContainer) {
          ordersContainer.innerHTML = `
            <div class="error-message">
              <strong>Error loading orders</strong><br>
              ${error.message}
            </div>
          `;
        }
      }
    }
    
    async function syncSingleOrder(orderId) {
      if (!confirm('Sync this order now?')) return;
      
      try {
        const response = await fetch('/admin/api/orders/sync-selected', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderIds: [orderId] }),
        });
        
        const data = await response.json();
        if (data.success) {
          alert(`Order synced successfully!`);
          loadOrders();
          loadStats();
        } else {
          alert('Sync failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error syncing order:', error);
        alert('Error syncing order: ' + error.message);
      }
    }
    
    async function retryOrder(orderId) {
      if (!confirm('Retry syncing this order?')) return;
      
      try {
        const response = await fetch(`/admin/api/orders/${orderId}/retry`, {
          method: 'POST',
        });
        
        const data = await response.json();
        if (data.success) {
          alert('Order retried successfully!');
          loadOrders();
          loadStats();
        } else {
          alert('Retry failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error retrying order:', error);
        alert('Error retrying order: ' + error.message);
      }
    }
    
    // Load status on page load
    console.log('[App] Page loaded, shop:', shop);
    loadAppStatus();
    
    // Refresh stats every 30 seconds
    setInterval(() => {
      if (shop) {
        loadStats();
        loadOrders();
      }
    }, 30000);
  </script>
</body>
</html>
