<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="shopify-api-key" content="<%= SHOPIFY_API_KEY %>">
  <title>Delybell Order Sync Dashboard</title>
  
  <!-- Shopify App Bridge -->
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge-utils.js"></script>
  <script>
    window.SHOPIFY_API_KEY = '<%= SHOPIFY_API_KEY %>';
    window.SHOPIFY_SHOP = '<%= shop %>';
  </script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#010a8b", // Delybell Blue
            "primary-purple": "#7c3aed", // Delybell Purple
            "background-light": "#fafafa",
            "background-dark": "#0a0a0a",
            "surface-light": "#ffffff",
            "surface-dark": "#1a1a1a",
            "border-light": "#e5e5e5",
            "border-dark": "#2a2a2a",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            sans: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "8px",
          },
        },
      },
    };
  </script>
  
  <style>
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      letter-spacing: -0.01em;
    }
    
    /* Framer-style smooth scrolling */
    html {
      scroll-behavior: smooth;
    }
    
    /* Custom scrollbar - minimal */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { 
      background: rgba(0,0,0,0.1); 
      border-radius: 3px;
      transition: background 0.2s;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
    .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
    .dark ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    
    /* Orders Table - Framer style */
    .orders-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
    }
    
    .orders-table th,
    .orders-table td {
      padding: 12px 16px;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      transition: background 0.15s ease;
    }
    
    .dark .orders-table th,
    .dark .orders-table td {
      border-bottom-color: rgba(255,255,255,0.05);
    }
    
    .orders-table th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      padding: 10px 16px;
    }
    
    .dark .orders-table th {
      background: rgba(26,26,26,0.95);
      color: #9ca3af;
    }
    
    .orders-table tbody tr {
      transition: all 0.15s ease;
    }
    
    .orders-table tbody tr:hover {
      background: rgba(0,0,0,0.02);
    }
    
    .dark .orders-table tbody tr:hover {
      background: rgba(255,255,255,0.02);
    }
    
    .orders-table td {
      white-space: normal;
      font-size: 13px;
    }
    
    .orders-table td:first-child,
    .orders-table th:first-child {
      padding-left: 16px;
    }
    
    .orders-table td:last-child,
    .orders-table th:last-child {
      padding-right: 16px;
    }
    
    .orders-table .col-order-number {
      min-width: 90px;
      white-space: nowrap;
      font-weight: 600;
      color: #111827;
      font-size: 13px;
    }
    
    .dark .orders-table .col-order-number {
      color: #f9fafb;
    }
    
    .orders-table .col-date {
      min-width: 140px;
      white-space: nowrap;
      color: #6b7280;
      font-size: 12px;
    }
    
    .dark .orders-table .col-date {
      color: #9ca3af;
    }
    
    .orders-table .col-payment {
      min-width: 100px;
      text-align: center;
    }
    
    .orders-table .col-status {
      min-width: 120px;
    }
    
    .orders-table .col-delybell-id {
      min-width: 130px;
      font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      color: #6b7280;
    }
    
    .dark .orders-table .col-delybell-id {
      color: #9ca3af;
    }
    
    .orders-table .col-action {
      min-width: 120px;
      text-align: right;
      white-space: nowrap;
    }
    
    /* Framer-style buttons */
    button {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    /* Smooth transitions */
    * {
      transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 150ms;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .toast {
      background: #ffffff;
      border: 1px solid #e1e3e5;
      border-left: 4px solid #008060;
      border-radius: 6px;
      padding: 14px 18px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 300px;
      max-width: 400px;
      display: flex;
      align-items: start;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }
    
    .dark .toast {
      background: #2a2a2a;
      border-color: #3e3e3e;
    }
    
    .toast.success { border-left-color: #010a8b; }
    .toast.error { border-left-color: #d72c0d; }
    .toast.warning { border-left-color: #f59e0b; }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #ffffff;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .dark .modal-content {
      background: #2a2a2a;
      color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-[#fafafa] dark:bg-[#0a0a0a] text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200">
  <div class="max-w-[1800px] mx-auto px-6 py-6">
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Header - Minimal Flat Style -->
    <header class="mb-6 flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900 dark:text-white mb-1 tracking-tight">Orders</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm">Manage and sync orders</p>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md font-medium text-xs hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors inline-flex items-center gap-1.5" onclick="showReportProblemModal()">
          <span class="material-icons-outlined text-sm">bug_report</span>
          Report
        </button>
        <a href="/app/help-center" class="px-3 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md font-medium text-xs hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors inline-flex items-center gap-1.5">
          <span class="material-icons-outlined text-sm">help_outline</span>
          Help
        </a>
      </div>
    </header>
    
    <!-- App Content -->
    <div id="app-content">
      <div class="flex items-center justify-center py-20">
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
          <p class="text-slate-500 dark:text-slate-400">Loading...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Dark Mode Toggle -->
  <div class="fixed bottom-6 right-6">
    <button class="p-3 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-full shadow-lg hover:scale-110 transition-transform" onclick="document.documentElement.classList.toggle('dark')">
      <span class="material-icons-outlined dark:hidden">dark_mode</span>
      <span class="material-icons-outlined hidden dark:block text-yellow-400">light_mode</span>
    </button>
  </div>
  
  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="font-bold text-lg mb-4" id="modalTitle">Confirm Action</div>
      <div class="text-slate-600 dark:text-slate-400 mb-6" id="modalBody">Are you sure?</div>
      <div class="flex gap-3 justify-end">
        <button class="px-4 py-2 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded font-medium text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" onclick="closeModal()">Cancel</button>
        <button class="px-4 py-2 bg-primary text-white rounded font-medium text-sm hover:opacity-90 transition-opacity" id="modalConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Report Problem Modal -->
  <div class="modal" id="reportProblemModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-slate-900 dark:text-white">Report a Problem</h2>
        <button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300" onclick="closeReportModal()">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>
      <form id="reportProblemForm" onsubmit="submitProblemReport(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Subject</label>
            <input type="text" id="reportSubject" required class="w-full px-4 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Brief description of the issue">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Order # (Optional)</label>
            <input type="text" id="reportOrderNumber" class="w-full px-4 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" placeholder="e.g., #1033">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Describe the Problem</label>
            <textarea id="reportMessage" required rows="5" class="w-full px-4 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-surface-dark text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none" placeholder="Please provide as much detail as possible about the issue you're experiencing..."></textarea>
          </div>
          <div class="bg-blue-50 dark:bg-blue-900/10 border border-blue-200 dark:border-blue-900/30 rounded-lg p-3">
            <p class="text-xs text-blue-800 dark:text-blue-400">
              <span class="material-icons-outlined text-sm align-middle mr-1">info</span>
              Your report will be reviewed by our support team. We'll get back to you as soon as possible.
            </p>
          </div>
        </div>
        <div class="flex gap-3 justify-end mt-6">
          <button type="button" class="px-4 py-2 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded font-medium text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" onclick="closeReportModal()">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded font-medium text-sm hover:opacity-90 transition-opacity inline-flex items-center gap-2">
            <span class="material-icons-outlined text-sm">send</span>
            Submit Report
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    let app;
    let shop = window.SHOPIFY_SHOP || '<%= shop %>';
    const apiKey = window.SHOPIFY_API_KEY;
    let currentPage = 1;
    let pageSize = 10;
    let totalOrders = 0;
    let currentTab = 'all';
    
    // Toast Notification System - User-friendly messages
    function showToast(type, title, message, duration = 5000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      // User-friendly icons and messages
      const icons = {
        success: '<span class="material-icons-outlined text-green-600 dark:text-green-400">check_circle</span>',
        error: '<span class="material-icons-outlined text-red-600 dark:text-red-400">error</span>',
        warning: '<span class="material-icons-outlined text-yellow-600 dark:text-yellow-400">warning</span>'
      };
      
      // Convert technical messages to user-friendly ones
      let friendlyMessage = message;
      if (message) {
        const msgLower = message.toLowerCase();
        if (msgLower.includes('synced') || msgLower.includes('successfully')) {
          friendlyMessage = message.replace(/synced|successfully/gi, 'sent to Delybell');
        }
        if (msgLower.includes('failed')) {
          friendlyMessage = message.replace(/failed/gi, 'could not be sent');
        }
        if (msgLower.includes('error') || msgLower.includes('unknown error')) {
          friendlyMessage = 'Something went wrong. Please try again or contact support if the problem continues.';
        }
        if (msgLower.includes('network') || msgLower.includes('timeout')) {
          friendlyMessage = 'Connection problem. Please check your internet and try again.';
        }
      }
      
      toast.innerHTML = `
        ${icons[type] || icons.success}
        <div style="flex: 1;">
          <div style="font-weight: 600; margin-bottom: 4px; color: #202223;">${title}</div>
          ${friendlyMessage ? `<div style="font-size: 13px; color: #6d7175; line-height: 1.5;">${friendlyMessage}</div>` : ''}
        </div>
        <span class="material-icons-outlined cursor-pointer text-slate-400 hover:text-slate-600 dark:hover:text-slate-300" onclick="this.parentElement.remove()" style="font-size: 20px;">close</span>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // Initialize App Bridge
    if (apiKey && apiKey !== 'SHOPIFY_API_KEY_NOT_SET' && apiKey !== '<%= SHOPIFY_API_KEY %>') {
      try {
        if (window['app-bridge']) {
          const AppBridge = window['app-bridge'].default;
          const createApp = AppBridge.default;
          
          const appConfig = { apiKey: apiKey };
          if (shop) appConfig.shopOrigin = shop;
          
          window.app = createApp(appConfig);
          
          if (AppBridge.actions) {
            const TitleBar = AppBridge.actions.TitleBar;
            TitleBar.create(window.app, { title: 'Delybell Order Sync' });
          }
        }
      } catch (appBridgeError) {
        console.warn('App Bridge initialization failed:', appBridgeError);
      }
    }
    
    if (!shop) {
      const urlParams = new URLSearchParams(window.location.search);
      shop = urlParams.get('shop') || urlParams.get('shopOrigin');
      
      // Also try to get from sessionStorage (persisted from previous visit)
      if (!shop) {
        shop = sessionStorage.getItem('shopDomain');
      }
      
      // Also check if we're in an embedded app (Shopify admin)
      if (!shop && window.location !== window.parent.location) {
        try {
          // Try to extract from parent URL if embedded
          const parentUrl = document.referrer;
          if (parentUrl) {
            const match = parentUrl.match(/admin\.shopify\.com\/store\/([^\/\?]+)/);
            if (match) {
              shop = match[1] + '.myshopify.com';
            }
          }
        } catch (e) {
          console.warn('Could not extract shop from referrer:', e);
        }
      }
    }
    
    // Persist shop to sessionStorage for navigation
    if (shop) {
      sessionStorage.setItem('shopDomain', shop);
    }
    
    // Human-readable error messages
    function getFriendlyError(errorMessage) {
      if (!errorMessage) return 'Unknown error occurred';
      
      const error = errorMessage.toLowerCase();
      
      if (error.includes('block') && error.includes('not found')) {
        return 'Address issue: Block not found. Ask customer to re-check address.';
      }
      if (error.includes('road') && error.includes('not found')) {
        return 'Address issue: Road not found. Order will sync with block only.';
      }
      if (error.includes('building') && error.includes('not found')) {
        return 'Address issue: Building not found. Order will sync without building.';
      }
      if (error.includes('validation')) {
        return 'Address validation failed. Please check customer address details.';
      }
      if (error.includes('network') || error.includes('timeout')) {
        return 'Connection issue: Unable to reach Delybell. Please try again.';
      }
      if (error.includes('authentication') || error.includes('unauthorized')) {
        return 'Authentication failed. Please contact support.';
      }
      
      return errorMessage.length > 100 ? errorMessage.substring(0, 100) + '...' : errorMessage;
    }
    
    // Modal functions
    function showModal(title, body, onConfirm) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').textContent = body;
      const confirmBtn = document.getElementById('modalConfirmBtn');
      confirmBtn.onclick = () => {
        onConfirm();
        closeModal();
      };
      document.getElementById('confirmModal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('confirmModal').classList.remove('active');
    }
    
    // Report Problem Modal Functions
    function showReportProblemModal() {
      const modal = document.getElementById('reportProblemModal');
      if (modal) {
        modal.classList.add('active');
        // Reset form
        document.getElementById('reportProblemForm').reset();
      }
    }
    
    function closeReportModal() {
      const modal = document.getElementById('reportProblemModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    async function submitProblemReport(event) {
      event.preventDefault();
      
      const subject = document.getElementById('reportSubject').value.trim();
      const message = document.getElementById('reportMessage').value.trim();
      const orderNumber = document.getElementById('reportOrderNumber').value.trim();
      
      if (!subject || !message) {
        showToast('warning', 'Missing Information', 'Please fill in all required fields.');
        return;
      }
      
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="material-icons-outlined text-sm animate-spin">sync</span> Submitting...';
      
      try {
        const response = await fetch('/app/api/report-problem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shop: shop,
            subject: subject,
            message: message,
            orderNumber: orderNumber || null,
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          showToast('success', 'Report Submitted', 'Thank you! Your report has been submitted. We\'ll review it and get back to you soon.');
          closeReportModal();
        } else {
          showToast('error', 'Submission Failed', data.error || 'Unable to submit your report. Please try again.');
        }
      } catch (error) {
        console.error('Error submitting report:', error);
        showToast('error', 'Something Went Wrong', 'Please try again. If this continues, contact support.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }
    
    // Close report modal when clicking outside
    document.addEventListener('DOMContentLoaded', () => {
      const reportModal = document.getElementById('reportProblemModal');
      if (reportModal) {
        reportModal.addEventListener('click', (e) => {
          if (e.target.id === 'reportProblemModal') {
            closeReportModal();
          }
        });
      }
    });
    
    // Load connection health
    async function loadConnectionHealth() {
      if (!shop) return { shopify: false, delybell: false, lastSync: null };
      
      try {
        const authResponse = await fetch(`/auth/check?shop=${encodeURIComponent(shop)}`);
        const authData = await authResponse.json();
        const shopifyConnected = authData.authenticated || false;
        
        let delybellConnected = false;
        try {
          const blocksResponse = await fetch('/admin/api/delybell-health');
          if (blocksResponse.ok) {
            const blocksData = await blocksResponse.json();
            delybellConnected = blocksData.success || false;
          }
        } catch (e) {
          console.warn('Delybell health check failed:', e);
        }
        
        // Get actual last sync time from most recently synced order
        let lastSync = null;
        try {
          const lastSyncResponse = await fetch(`/admin/api/orders?shop=${encodeURIComponent(shop)}&status=processed&limit=1`);
          const lastSyncData = await lastSyncResponse.json();
          if (lastSyncData.success && lastSyncData.orders && lastSyncData.orders.length > 0) {
            const mostRecentOrder = lastSyncData.orders[0];
            // Use syncedAt if available, otherwise fall back to createdAt
            const syncedAt = mostRecentOrder.syncedAt || mostRecentOrder.createdAt;
            if (syncedAt) {
              const syncDate = new Date(syncedAt);
              const now = new Date();
              const diffMs = now.getTime() - syncDate.getTime();
              const diffMins = Math.floor(diffMs / 60000);
              const diffHours = Math.floor(diffMs / 3600000);
              const diffDays = Math.floor(diffMs / 86400000);
              
              if (diffMins < 1) {
                lastSync = 'Just now';
              } else if (diffMins < 60) {
                lastSync = `${diffMins} min ago`;
              } else if (diffHours < 24) {
                lastSync = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
              } else if (diffDays < 7) {
                lastSync = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
              } else {
                lastSync = syncDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              }
            }
          }
        } catch (e) {
          console.warn('Error fetching last sync time:', e);
        }
        
        return {
          shopify: shopifyConnected,
          delybell: delybellConnected,
          lastSync: lastSync,
          storeDomain: shop
        };
      } catch (error) {
        console.error('Error loading connection health:', error);
        return { shopify: false, delybell: false, lastSync: null, storeDomain: shop };
      }
    }
    // Load orders with pagination and filtering
    async function loadOrders(page = 1, statusFilter = null) {
      if (!shop) return;
      
      currentPage = page;
      const ordersContainer = document.getElementById('ordersContainer');
      
      if (ordersContainer) {
        ordersContainer.innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary mb-2"></div>
              <div>Loading orders...</div>
            </td>
          </tr>
        `;
      }
      
      try {
        const params = new URLSearchParams();
        params.append('shop', shop);
        params.append('limit', pageSize);
        params.append('offset', (page - 1) * pageSize);
        
        if (statusFilter && statusFilter !== 'all') {
          params.append('status', statusFilter);
        }
        
        const response = await fetch(`/admin/api/orders?${params}`);
        const data = await response.json();
        
        if (!data.success) {
          console.error('[App] Failed to load orders:', data.error);
          throw new Error(data.error || 'Failed to load orders');
        }
        
        let orders = data.orders || [];
        
        // Deduplicate orders by shopify_order_id - keep the most recent/important status
        // Priority: processed > completed > failed > pending_sync
        const orderMap = new Map();
        orders.forEach(order => {
          const key = order.shopifyOrderId || order.shopify_order_id;
          if (!key) return;
          
          const existing = orderMap.get(key);
          if (!existing) {
            orderMap.set(key, order);
          } else {
            // Priority: processed > completed > failed > pending_sync
            const statusPriority = {
              'processed': 4,
              'completed': 3,
              'failed': 2,
              'pending_sync': 1
            };
            const existingPriority = statusPriority[existing.status] || 0;
            const newPriority = statusPriority[order.status] || 0;
            
            // Keep the one with higher priority, or the more recent one if same priority
            if (newPriority > existingPriority) {
              orderMap.set(key, order);
            } else if (newPriority === existingPriority) {
              // If same priority, keep the one with more recent created_at
              const existingDate = new Date(existing.createdAt || existing.created_at || 0);
              const newDate = new Date(order.createdAt || order.created_at || 0);
              if (newDate > existingDate) {
                orderMap.set(key, order);
              }
            }
          }
        });
        
        orders = Array.from(orderMap.values());
        
        // CRITICAL: If filtering by pending_sync, exclude any orders that are synced/completed
        if (statusFilter === 'pending_sync') {
          orders = orders.filter(order => {
            const orderStatus = order.status;
            // Check for delybell_order_id in multiple possible field names (camelCase from API)
            const delybellId = order.delybellOrderId || order.delybell_order_id;
            const hasDelybellId = !!delybellId;
            
            // Only show truly pending orders:
            // 1. Status must be 'pending_sync'
            // 2. Must NOT have a delybell_order_id (not synced)
            if (orderStatus !== 'pending_sync') {
              return false; // Not pending status
            }
            if (hasDelybellId) {
              return false; // Has been synced (has delybell_order_id)
            }
            
            return true; // Truly pending (status is pending_sync and no delybell_order_id)
          });
          // Update total count for pending tab
          totalOrders = orders.length;
        } else {
          totalOrders = data.total !== undefined ? data.total : orders.length;
        }
        
        console.log(`[App] Loaded ${orders.length} orders (total: ${totalOrders}, filter: ${statusFilter || 'all'}, shop: ${shop})`);
        
        if (orders.length === 0) {
          if (ordersContainer) {
            const emptyMessage = statusFilter === 'pending_sync' 
              ? 'No pending orders. New orders placed by customers will appear here.'
              : statusFilter === 'processed'
              ? 'No synced or completed orders yet. Sync orders from the Pending tab to see them here.'
              : statusFilter === 'failed'
              ? 'No failed orders. Failed sync attempts will appear here.'
              : 'No orders yet. Orders placed by customers will appear here once they are received.';
            
            ordersContainer.innerHTML = `
              <tr>
                <td colspan="7" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
                  <span class="material-icons-outlined text-4xl mb-2 block">inbox</span>
                  <div class="font-semibold">No orders found</div>
                  <div class="text-sm mt-1">${emptyMessage}</div>
                </td>
              </tr>
            `;
          }
          updatePagination();
          return;
        }
        
        renderOrders(orders);
        updatePagination();
        updateOrderTabs();
      } catch (error) {
        console.error('Error loading orders:', error);
        if (ordersContainer) {
          ordersContainer.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-red-600 dark:text-red-400">
                <span class="material-icons-outlined text-4xl mb-2 block">error</span>
                <div class="font-semibold">Error loading orders</div>
                <div class="text-sm mt-1">${error.message}</div>
              </td>
            </tr>
          `;
        }
      }
    }
    
    // Update order tabs with counts
    async function updateOrderTabs() {
      try {
        // Fetch counts for each status separately to ensure accuracy
        const [allResponse, syncedResponse, pendingResponse, failedResponse] = await Promise.all([
          fetch(`/admin/api/orders?shop=${encodeURIComponent(shop)}&limit=1`),
          fetch(`/admin/api/orders?shop=${encodeURIComponent(shop)}&status=processed&limit=1`),
          fetch(`/admin/api/orders?shop=${encodeURIComponent(shop)}&status=pending_sync&limit=1`),
          fetch(`/admin/api/orders?shop=${encodeURIComponent(shop)}&status=failed&limit=1`)
        ]);
        
        const allData = await allResponse.json();
        const syncedData = await syncedResponse.json();
        const pendingData = await pendingResponse.json();
        const failedData = await failedResponse.json();
        
        const totalCount = allData.total || 0;
        const syncedCount = syncedData.total || 0;
        const pendingCount = pendingData.total || 0;
        const failedCount = failedData.total || 0;
        
        const syncedBadge = document.getElementById('syncedBadge');
        const pendingBadge = document.getElementById('pendingBadge');
        const failedBadge = document.getElementById('failedBadge');
        const allBadge = document.getElementById('allBadge');
        
        if (syncedBadge) syncedBadge.textContent = syncedCount;
        if (pendingBadge) pendingBadge.textContent = pendingCount;
        if (failedBadge) failedBadge.textContent = failedCount;
        if (allBadge) allBadge.textContent = totalCount;
      } catch (error) {
        console.error('Error updating order tabs:', error);
        // Fallback to stats API if individual queries fail
        try {
          const statsResponse = await fetch(`/admin/api/stats?shop=${encodeURIComponent(shop)}`);
          const statsData = await statsResponse.json();
          
          if (statsData.success) {
            const stats = statsData.stats;
            const syncedBadge = document.getElementById('syncedBadge');
            const pendingBadge = document.getElementById('pendingBadge');
            const failedBadge = document.getElementById('failedBadge');
            const allBadge = document.getElementById('allBadge');
            
            if (syncedBadge) syncedBadge.textContent = stats.successfullySynced || 0;
            if (pendingBadge) pendingBadge.textContent = stats.pendingSync || 0;
            if (failedBadge) failedBadge.textContent = stats.failed || 0;
            if (allBadge) allBadge.textContent = stats.totalOrdersToday || 0;
          }
        } catch (fallbackError) {
          console.error('Error in fallback stats update:', fallbackError);
        }
      }
    }
    
    function switchTab(tab) {
      currentTab = tab;
      currentPage = 1;
      
      // Update tab UI with smooth transitions
      document.querySelectorAll('.order-tab').forEach(t => {
        t.classList.remove('border-primary', 'text-primary', 'font-semibold', 'dark:text-primary');
        t.classList.add('border-transparent', 'text-slate-500', 'dark:text-slate-400', 'font-medium');
      });
      
      const activeTab = document.getElementById(`tab-${tab}`);
      if (activeTab) {
        activeTab.classList.remove('border-transparent', 'text-slate-500', 'dark:text-slate-400', 'font-medium');
        activeTab.classList.add('border-primary', 'text-primary', 'font-semibold', 'dark:text-primary');
      }
      
      // Load orders with filter
      const statusMap = {
        'all': null,
        'synced': 'processed', // Will include completed orders via API filter
        'pending': 'pending_sync',
        'failed': 'failed'
      };
      
      // Clear bulk selection when switching tabs
      document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
      updateBulkActions();
      
      loadOrders(1, statusMap[tab]);
    }
    
    function renderOrders(orders) {
      const ordersContainer = document.getElementById('ordersContainer');
      
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      function getStatusBadge(status, errorMessage) {
        if (status === 'processed') {
          return `<span class="inline-flex items-center px-1.5 py-0.5 bg-[#010a8b]/10 text-[#010a8b] text-[10px] font-semibold rounded">Synced</span>`;
        }
        if (status === 'completed') {
          return `<span class="inline-flex items-center px-1.5 py-0.5 bg-[#7c3aed]/10 text-[#7c3aed] text-[10px] font-semibold rounded">Completed</span>`;
        }
        if (status === 'pending_sync') {
          return `<span class="inline-flex items-center px-1.5 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-[10px] font-semibold rounded">Pending</span>`;
        }
        if (status === 'failed') {
          const hasError = errorMessage ? `
            <button class="text-[9px] text-[#010a8b] dark:text-[#7c3aed] hover:underline mt-1 text-left" onclick="toggleErrorDetails('error-${orders.indexOf(orders.find(o => o.status === 'failed'))}')">Show details</button>
          ` : '';
          return `<div class="flex flex-col">
            <span class="inline-flex items-center px-1.5 py-0.5 w-fit bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-[10px] font-semibold rounded">Failed</span>
            ${hasError}
          </div>`;
        }
        return `<span class="inline-flex items-center px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-[10px] font-semibold rounded">${status}</span>`;
      }
      
      function getPaymentBadge(financialStatus) {
        if (!financialStatus) return '<span class="text-slate-400 text-xs">—</span>';
        
        const status = financialStatus.toLowerCase();
        
        if (status === 'paid') {
          return `<span class="inline-flex items-center px-1.5 py-0.5 bg-[#010a8b]/10 text-[#010a8b] text-[10px] font-semibold rounded">PAID</span>`;
        }
        
        // COD or pending payment
        if (status === 'pending' || status === 'authorized' || status === 'partially_paid') {
          return `<span class="inline-flex items-center px-1.5 py-0.5 bg-[#7c3aed]/10 text-[#7c3aed] text-[10px] font-semibold rounded">COD</span>`;
        }
        
        // Other statuses
        return `<span class="inline-flex items-center px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-[10px] font-semibold rounded">${financialStatus.toUpperCase()}</span>`;
      }
      
      if (ordersContainer) {
        ordersContainer.innerHTML = orders.map((order, index) => {
          const hasError = order.status === 'failed' && order.errorMessage;
          const canSelect = order.status === 'pending_sync' || order.status === 'failed';
          return `
            <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors group">
              <td class="text-left" style="width: 50px; padding-left: 24px;">
                ${canSelect ? `<input type="checkbox" class="order-checkbox w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" value="${order.id}" onchange="updateBulkActions()">` : ''}
              </td>
              <td class="col-order-number font-semibold text-sm">#${order.shopifyOrderNumber || 'N/A'}</td>
              <td class="col-date text-slate-600 dark:text-slate-400 text-sm">${formatDate(order.createdAt)}</td>
              <td class="col-payment text-center">${getPaymentBadge(order.financialStatus)}</td>
              <td class="col-status">${getStatusBadge(order.status, order.errorMessage)}</td>
              <td class="col-delybell-id font-mono text-xs text-slate-600 dark:text-slate-400">${order.delybellOrderId || '—'}</td>
              <td class="col-action text-right" style="padding-right: 24px;">
                ${order.status === 'processed' || order.status === 'completed' ? `
                  <button class="inline-flex items-center px-2.5 py-1 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-semibold hover:border-[#010a8b] hover:text-[#010a8b] dark:hover:text-[#010a8b] transition-colors" onclick="viewOrderDetails('${order.id}')">
                    <span class="material-icons-outlined text-sm mr-1">visibility</span> View
                  </button>
                ` : ''}
                ${order.status === 'failed' ? `
                  <button class="inline-flex items-center px-2.5 py-1 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-semibold hover:border-[#010a8b] hover:text-[#010a8b] dark:hover:text-[#010a8b] transition-colors" onclick="retryOrder('${order.id}')">
                    <span class="material-icons-outlined text-sm mr-1">refresh</span> Retry
                  </button>
                ` : ''}
                ${order.status === 'pending_sync' ? `
                  <button class="inline-flex items-center px-2.5 py-1 bg-[#010a8b] text-white rounded-md text-xs font-semibold hover:opacity-90 transition-opacity" onclick="syncSingleOrder('${order.id}')">
                    <span class="material-icons-outlined text-sm mr-1">sync</span> Sync
                  </button>
                ` : ''}
              </td>
            </tr>
            ${hasError ? `
              <tr id="error-${index}" class="hidden">
                <td colspan="7" class="py-3 px-4 bg-red-50 dark:bg-red-900/10 border-l-4 border-red-500">
                  <div class="text-sm text-red-700 dark:text-red-400">${getFriendlyError(order.errorMessage)}</div>
                </td>
              </tr>
            ` : ''}
          `;
        }).join('');
      }
    }
    
    function toggleErrorDetails(id) {
      const row = document.getElementById(id);
      if (row) {
        row.classList.toggle('hidden');
      }
    }
    
    function updatePagination() {
      const paginationInfo = document.getElementById('paginationInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      if (paginationInfo) {
        if (totalOrders === 0) {
          paginationInfo.textContent = 'No orders';
        } else {
          const start = (currentPage - 1) * pageSize + 1;
          const end = Math.min(currentPage * pageSize, totalOrders);
          paginationInfo.textContent = `Showing ${start} to ${end} of ${totalOrders} orders`;
        }
      }
      
      if (prevBtn) {
        prevBtn.disabled = currentPage === 1;
        prevBtn.className = currentPage === 1
          ? 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-400 cursor-not-allowed text-sm'
          : 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm';
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentPage * pageSize >= totalOrders;
        nextBtn.className = currentPage * pageSize >= totalOrders
          ? 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-400 cursor-not-allowed text-sm'
          : 'p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm';
      }
    }
    
    async function fetchHistoricalOrders() {
      if (!shop) {
        showToast('error', 'Store Not Found', 'Could not detect your store. Please refresh the page.');
        return;
      }

      const btn = document.getElementById('fetchHistoricalBtn');
      const originalText = btn ? btn.innerHTML : '';
      
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons-outlined text-sm animate-spin">sync</span> Fetching...';
      }

      try {
        const response = await fetch(`/admin/api/orders/fetch-historical?shop=${encodeURIComponent(shop)}`, {
          method: 'POST',
        });
        
        const data = await response.json();
        
        if (data.success) {
          const message = data.saved > 0 
            ? `Found ${data.saved} new order${data.saved > 1 ? 's' : ''} from Shopify. ${data.existing} already existed.`
            : `No new orders found. All ${data.total} orders are already in the system.`;
          showToast('success', 'Historical Orders Fetched', message);
          
          // Reload orders to show the new ones
          await loadOrders(currentPage);
          updateOrderTabs();
        } else {
          showToast('error', 'Fetch Failed', data.error || 'Could not fetch historical orders. Please try again.');
        }
      } catch (error) {
        console.error('Error fetching historical orders:', error);
        showToast('error', 'Error', 'Could not fetch historical orders. Please try again.');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
    }
    
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox');
      if (selectAll) {
        const checked = selectAll.checked;
        document.querySelectorAll('.order-checkbox:not(:disabled)').forEach(cb => {
          cb.checked = checked;
        });
        updateBulkActions();
      }
    }
    
    function updateBulkActions() {
      const checked = document.querySelectorAll('.order-checkbox:checked').length;
      const bulkActions = document.getElementById('bulkActions');
      const bulkCount = document.getElementById('bulkCount');
      const bulkSyncBtn = document.getElementById('bulkSyncBtn');
      const bulkRetryBtn = document.getElementById('bulkRetryBtn');
      
      if (bulkActions) bulkActions.classList.toggle('hidden', checked === 0);
      if (bulkCount) bulkCount.textContent = `${checked} selected`;
      if (bulkSyncBtn) bulkSyncBtn.disabled = checked === 0;
      if (bulkRetryBtn) bulkRetryBtn.disabled = checked === 0;
    }
    
    async function syncSelectedOrders() {
      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        showToast('warning', 'No Orders Selected', 'Please select orders to sync.');
        return;
      }
      
      showModal(
        'Sync Selected Orders',
        `Sync ${checked.length} selected order${checked.length > 1 ? 's' : ''} to Delybell?`,
        async () => {
          closeModal();
          
          // Show progress indicator
          const ordersContainer = document.getElementById('ordersContainer');
          const originalContent = ordersContainer ? ordersContainer.innerHTML : '';
          
          if (ordersContainer) {
            ordersContainer.innerHTML = `
              <tr>
                <td colspan="7" class="px-6 py-8 text-center">
                  <div class="inline-flex flex-col items-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-3"></div>
                    <div class="font-semibold text-slate-700 dark:text-slate-300">Syncing ${checked.length} order${checked.length > 1 ? 's' : ''}...</div>
                    <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">Please wait</div>
                  </div>
                </td>
              </tr>
            `;
          }
          
          // Disable sync buttons
          const bulkSyncBtn = document.getElementById('bulkSyncBtn');
          if (bulkSyncBtn) bulkSyncBtn.disabled = true;
          
          try {
            const response = await fetch('/admin/api/orders/sync-selected', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderIds: checked }),
            });
            
            const data = await response.json();
            if (data.success) {
              if (data.synced > 0) {
                let message = `${data.synced} order${data.synced > 1 ? 's' : ''} sent to Delybell successfully!`;
                if (data.skipped > 0) {
                  message += ` ${data.skipped} order${data.skipped > 1 ? 's were' : ' was'} skipped (already completed).`;
                }
                if (data.failed > 0) {
                  message += ` ${data.failed} order${data.failed > 1 ? 's' : ''} could not be sent.`;
                }
                showToast('success', 'Orders Sent', message);
              } else if (data.skipped > 0) {
                showToast('warning', 'Orders Skipped', `${data.skipped} order${data.skipped > 1 ? 's were' : ' was'} skipped because ${data.skipped > 1 ? 'they are' : 'it is'} already completed.`);
              } else {
                showToast('error', 'Could Not Send Orders', data.message || 'No orders were sent. Please try again.');
              }
              
              // Reload orders and update UI
              await loadOrders(currentPage);
              loadConnectionHealth();
              updateOrderTabs();
              updateBulkActions();
            } else {
              showToast('error', 'Could Not Send Orders', data.error || 'Some orders could not be sent. Please try again.');
              if (ordersContainer) ordersContainer.innerHTML = originalContent;
            }
          } catch (error) {
            console.error('Error syncing orders:', error);
            showToast('error', 'Error', 'Could not sync orders. Please try again.');
            if (ordersContainer) ordersContainer.innerHTML = originalContent;
          } finally {
            if (bulkSyncBtn) bulkSyncBtn.disabled = false;
          }
        }
      );
    }
    
    async function retryFailedOrders() {
      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        showToast('warning', 'No Orders Selected', 'Please select failed orders to retry.');
        return;
      }
      
      showModal(
        'Retry Failed Orders',
        `Retry syncing ${checked.length} failed order${checked.length > 1 ? 's' : ''}?`,
        async () => {
          closeModal();
          
          // Show progress indicator
          const ordersContainer = document.getElementById('ordersContainer');
          const originalContent = ordersContainer ? ordersContainer.innerHTML : '';
          
          if (ordersContainer) {
            ordersContainer.innerHTML = `
              <tr>
                <td colspan="7" class="px-6 py-8 text-center">
                  <div class="inline-flex flex-col items-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-3"></div>
                    <div class="font-semibold text-slate-700 dark:text-slate-300">Retrying ${checked.length} order${checked.length > 1 ? 's' : ''}...</div>
                    <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">Please wait</div>
                  </div>
                </td>
              </tr>
            `;
          }
          
          // Disable retry buttons
          const bulkRetryBtn = document.getElementById('bulkRetryBtn');
          if (bulkRetryBtn) bulkRetryBtn.disabled = true;
          
          try {
            const results = await Promise.all(
              checked.map(id => fetch(`/admin/api/orders/${id}/retry`, { method: 'POST' }))
            );
            
            let success = 0;
            let failed = 0;
            
            for (const result of results) {
              const data = await result.json();
              if (data.success) success++;
              else failed++;
            }
            
            if (success > 0) {
              const successMsg = `${success} order${success > 1 ? 's' : ''} sent to Delybell successfully!`;
              const failMsg = failed > 0 
                ? ` ${failed} order${failed > 1 ? 's' : ''} still could not be sent.`
                : '';
              showToast('success', 'Orders Sent', successMsg + failMsg);
            } else {
              showToast('error', 'Could Not Send Orders', failed > 0 
                ? `${failed} order${failed > 1 ? 's' : ''} could not be sent. Please try again.`
                : 'No orders were sent. Please try again.');
            }
            
            // Reload orders and update UI
            await loadOrders(currentPage);
            loadConnectionHealth();
            updateOrderTabs();
            updateBulkActions();
          } catch (error) {
            console.error('Error retrying orders:', error);
            showToast('error', 'Error', 'Could not retry orders. Please try again.');
            if (ordersContainer) ordersContainer.innerHTML = originalContent;
          } finally {
            if (bulkRetryBtn) bulkRetryBtn.disabled = false;
          }
        }
      );
    }
    
    async function syncSingleOrder(orderId) {
      showModal(
        'Sync Order',
        'Sync this order to Delybell now?',
        async () => {
          closeModal();
          
          // Show progress on the button
          const syncBtn = event.target.closest('button');
          const originalContent = syncBtn ? syncBtn.innerHTML : '';
          if (syncBtn) {
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<span class="material-icons-outlined text-sm mr-1 animate-spin">sync</span> Syncing...';
          }
          
          try {
            const response = await fetch('/admin/api/orders/sync-selected', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderIds: [orderId] }),
            });
            
            const data = await response.json();
            if (data.success) {
              if (data.synced > 0) {
                showToast('success', 'Order Sent', 'This order has been sent to Delybell successfully!');
                await loadOrders(currentPage);
                loadConnectionHealth();
                updateOrderTabs();
                updateBulkActions();
              } else if (data.skipped > 0) {
                showToast('warning', 'Order Skipped', 'This order is already completed and cannot be synced.');
                await loadOrders(currentPage);
                updateOrderTabs();
                updateBulkActions();
                if (syncBtn) {
                  syncBtn.innerHTML = originalContent;
                  syncBtn.disabled = false;
                }
              } else {
                const errorMsg = data.message || 'Could not send this order. Please try again.';
                showToast('error', 'Could Not Send Order', errorMsg);
                if (syncBtn) {
                  syncBtn.innerHTML = originalContent;
                  syncBtn.disabled = false;
                }
              }
            } else {
              const errorMsg = data.error || 'Could not send this order. Please try again.';
              showToast('error', 'Could Not Send Order', errorMsg);
              if (syncBtn) {
                syncBtn.innerHTML = originalContent;
                syncBtn.disabled = false;
              }
            }
          } catch (error) {
            console.error('Error syncing order:', error);
            showToast('error', 'Error', error.message);
            if (syncBtn) {
              syncBtn.innerHTML = originalContent;
              syncBtn.disabled = false;
            }
          }
        }
      );
    }
    
    async function retryOrder(orderId) {
      showModal(
        'Retry Order',
        'Retry syncing this order?',
        async () => {
          closeModal();
          
          // Show progress on the button
          const retryBtn = event.target.closest('button');
          const originalContent = retryBtn ? retryBtn.innerHTML : '';
          if (retryBtn) {
            retryBtn.disabled = true;
            retryBtn.innerHTML = '<span class="material-icons-outlined text-sm mr-1 animate-spin">sync</span> Retrying...';
          }
          
          try {
            const response = await fetch(`/admin/api/orders/${orderId}/retry`, { method: 'POST' });
            const data = await response.json();
            if (data.success) {
              showToast('success', 'Order Sent', 'This order has been sent to Delybell successfully!');
              await loadOrders(currentPage);
              loadConnectionHealth();
              updateOrderTabs();
            } else {
              showToast('error', 'Could Not Send Order', data.error || 'This order could not be sent. Please check the error details or contact support.');
              if (retryBtn) {
                retryBtn.innerHTML = originalContent;
                retryBtn.disabled = false;
              }
            }
          } catch (error) {
            console.error('Error retrying order:', error);
            showToast('error', 'Something Went Wrong', 'Please try again. If this continues, contact support.');
            if (retryBtn) {
              retryBtn.innerHTML = originalContent;
              retryBtn.disabled = false;
            }
          }
        }
      );
    }
    
    async function viewOrderDetails(orderId) {
      try {
        const response = await fetch(`/admin/api/orders/${orderId}`);
        const data = await response.json();
        
        if (data.success && data.order) {
          const order = data.order;
          const modalTitle = document.getElementById('modalTitle');
          const modalBody = document.getElementById('modalBody');
          const modalConfirmBtn = document.getElementById('modalConfirmBtn');
          
          if (modalTitle && modalBody && modalConfirmBtn) {
            modalTitle.textContent = `Order #${order.shopifyOrderNumber || 'N/A'}`;
            
            const orderDetails = `
              <div class="space-y-4 text-sm">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Order Number</p>
                    <p class="font-semibold">#${order.shopifyOrderNumber || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Status</p>
                    <p class="font-semibold">${order.status === 'processed' ? 'Synced' : order.status === 'pending_sync' ? 'Pending' : order.status === 'failed' ? 'Failed' : order.status}</p>
                  </div>
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Payment</p>
                    <p class="font-semibold">${order.financialStatus === 'paid' ? 'Paid' : order.financialStatus === 'pending' || order.financialStatus === 'authorized' ? 'Cash on Delivery' : order.financialStatus ? order.financialStatus.charAt(0).toUpperCase() + order.financialStatus.slice(1) : 'Unknown'}</p>
                  </div>
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Amount</p>
                    <p class="font-semibold">${order.currency || 'USD'} ${order.amount || '0.00'}</p>
                  </div>
                </div>
                ${order.delybellOrderId ? `
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Delybell Order ID</p>
                    <p class="font-mono text-xs font-semibold">${order.delybellOrderId}</p>
                  </div>
                ` : ''}
                ${order.customerName ? `
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Customer</p>
                    <p class="font-semibold">${order.customerName}</p>
                  </div>
                ` : ''}
                ${order.phone ? `
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Phone</p>
                    <p class="font-semibold">${order.phone}</p>
                  </div>
                ` : ''}
                ${order.createdAt ? `
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Order Placed</p>
                    <p class="font-semibold">${new Date(order.createdAt).toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'short' })}</p>
                  </div>
                ` : ''}
                ${order.syncedAt ? `
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Synced At</p>
                    <p class="font-semibold">${new Date(order.syncedAt).toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'short' })}</p>
                  </div>
                ` : order.status === 'pending_sync' ? `
                  <div>
                    <p class="text-slate-500 dark:text-slate-400 mb-1">Synced At</p>
                    <p class="font-semibold text-yellow-600 dark:text-yellow-400">Not synced yet</p>
                  </div>
                ` : ''}
                ${order.errorMessage ? `
                  <div class="mt-4 p-3 bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 rounded">
                    <p class="text-red-700 dark:text-red-400 text-xs font-semibold mb-1">Error Message</p>
                    <p class="text-red-600 dark:text-red-500 text-xs">${getFriendlyError(order.errorMessage)}</p>
                  </div>
                ` : ''}
              </div>
            `;
            
            modalBody.innerHTML = orderDetails;
            modalConfirmBtn.textContent = 'Close';
            modalConfirmBtn.onclick = () => closeModal();
            
            document.getElementById('confirmModal').classList.add('active');
          }
        } else {
          showToast('error', 'Could Not Load Order', 'Unable to fetch order details. Please try again.');
        }
      } catch (error) {
        console.error('Error loading order details:', error);
        showToast('error', 'Something Went Wrong', 'Please try again. If this continues, contact support.');
      }
    }
    
    // Load app status
    async function loadAppStatus() {
      const appContent = document.getElementById('app-content');
      
      try {
        // Ensure shop is set (re-check if needed)
        if (!shop) {
          const urlParams = new URLSearchParams(window.location.search);
          shop = urlParams.get('shop') || urlParams.get('shopOrigin');
          
          // Try sessionStorage
          if (!shop) {
            shop = sessionStorage.getItem('shopDomain');
          }
          
          // Try to extract from referrer if embedded
          if (!shop && document.referrer) {
            const match = document.referrer.match(/admin\.shopify\.com\/store\/([^\/\?]+)/);
            if (match) {
              shop = match[1] + '.myshopify.com';
              sessionStorage.setItem('shopDomain', shop);
            }
          }
        }
        
        // If still no shop, try to wait a bit for App Bridge to initialize
        if (!shop) {
          // Wait for App Bridge to potentially set shop
          await new Promise(resolve => setTimeout(resolve, 500));
          shop = window.SHOPIFY_SHOP || sessionStorage.getItem('shopDomain');
        }
        
        if (!shop) {
          // Show loading state
          if (appContent) {
            appContent.innerHTML = `
              <div class="flex items-center justify-center py-20">
                <div class="text-center">
                  <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                  <p class="text-slate-500 dark:text-slate-400">Detecting store...</p>
                </div>
              </div>
            `;
          }
          // Try one more time after a delay
          setTimeout(() => {
            shop = window.SHOPIFY_SHOP || sessionStorage.getItem('shopDomain') || new URLSearchParams(window.location.search).get('shop');
            if (shop) {
              loadAppStatus();
            } else {
              // No shop detected - this shouldn't happen for App Store apps
              // But handle gracefully
              if (appContent) {
                appContent.innerHTML = `
                  <div class="max-w-2xl mx-auto py-20 text-center">
                    <p class="text-slate-500 dark:text-slate-400">Unable to detect store. Please install the app from the Shopify App Store.</p>
                  </div>
                `;
              }
            }
          }, 1000);
          return;
        }
        
        // Persist shop for navigation
        sessionStorage.setItem('shopDomain', shop);
        
        // CRITICAL: Server-side route already verified authentication BEFORE rendering this page
        // If we reach here, the user IS authenticated (server would have redirected to OAuth otherwise)
        // Trust the server-side check - don't check again client-side
        // This prevents race conditions and ensures smooth App Store flow
        // Just load the dashboard directly
        
        // Load everything in parallel for faster loading
        const [health] = await Promise.all([
          loadConnectionHealth().catch(err => {
            console.error('Error loading health:', err);
            return { shopify: false, delybell: false, storeDomain: shop, lastSync: 'Unknown' };
          })
        ]);
        
        // Render main app (orders will load separately after render)
        if (appContent) {
          appContent.innerHTML = `
            <!-- Health Status Cards - Minimal Flat -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
              <div class="bg-white dark:bg-surface-dark p-3 rounded-lg border border-border-light dark:border-border-dark flex items-center gap-3">
                <div class="w-8 h-8 rounded-md flex items-center justify-center ${health.shopify ? 'bg-[#010a8b]/10' : 'bg-slate-100 dark:bg-slate-800'}">
                  <span class="material-icons-outlined text-sm ${health.shopify ? 'text-[#010a8b]' : 'text-slate-400'}">check_circle</span>
                </div>
                <div class="min-w-0">
                  <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">Shopify</p>
                  <p class="font-semibold text-sm text-slate-900 dark:text-white truncate">${health.shopify ? 'Connected' : 'Offline'}</p>
                </div>
              </div>
              <div class="bg-white dark:bg-surface-dark p-3 rounded-lg border border-border-light dark:border-border-dark flex items-center gap-3">
                <div class="w-8 h-8 rounded-md flex items-center justify-center ${health.delybell ? 'bg-[#7c3aed]/10' : 'bg-slate-100 dark:bg-slate-800'}">
                  <span class="material-icons-outlined text-sm ${health.delybell ? 'text-[#7c3aed]' : 'text-slate-400'}">check_circle</span>
                </div>
                <div class="min-w-0">
                  <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">Delybell</p>
                  <p class="font-semibold text-sm text-slate-900 dark:text-white truncate">${health.delybell ? 'Connected' : 'Offline'}</p>
                </div>
              </div>
              <div class="bg-white dark:bg-surface-dark p-3 rounded-lg border border-border-light dark:border-border-dark flex items-center gap-3">
                <div class="w-8 h-8 rounded-md flex items-center justify-center bg-[#010a8b]/10">
                  <span class="material-icons-outlined text-sm text-[#010a8b]">storefront</span>
                </div>
                <div class="min-w-0 flex-1">
                  <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">Store</p>
                  <p class="font-semibold text-sm text-slate-900 dark:text-white truncate">${(health.storeDomain || shop).replace('.myshopify.com', '')}</p>
                </div>
              </div>
              <div class="bg-white dark:bg-surface-dark p-3 rounded-lg border border-border-light dark:border-border-dark flex items-center gap-3">
                <div class="w-8 h-8 rounded-md flex items-center justify-center bg-slate-100 dark:bg-slate-800">
                  <span class="material-icons-outlined text-sm text-slate-400">schedule</span>
                </div>
                <div class="min-w-0">
                  <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">Last Sync</p>
                  <p class="font-semibold text-sm text-slate-900 dark:text-white truncate">${health.lastSync || 'Never'}</p>
                </div>
              </div>
            </div>
            
            
            <!-- Orders Card - Minimal Flat -->
            <div class="bg-white dark:bg-surface-dark rounded-lg border border-border-light dark:border-border-dark overflow-hidden">
              <div class="p-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
                <h2 class="font-semibold text-base text-slate-900 dark:text-white">Orders</h2>
                <div class="flex items-center gap-1.5">
                  <button class="flex items-center gap-1.5 px-2.5 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" onclick="fetchHistoricalOrders()" id="fetchHistoricalBtn" title="Fetch orders placed before app installation">
                    <span class="material-icons-outlined text-sm">download</span>
                    Fetch
                  </button>
                  <button class="flex items-center gap-1.5 px-2.5 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" onclick="loadOrders(currentPage)">
                    <span class="material-icons-outlined text-sm">refresh</span>
                    Refresh
                  </button>
                </div>
              </div>
              
              <!-- Order Tabs - Minimal Flat -->
              <div class="flex items-center gap-0.5 px-4 pt-3 pb-0 border-b border-border-light dark:border-border-dark bg-white dark:bg-surface-dark">
                <button class="order-tab pb-3 px-3 border-b-2 border-[#010a8b] text-[#010a8b] font-semibold text-xs flex items-center gap-1.5 transition-all" id="tab-all" onclick="switchTab('all')">
                  <span>All</span>
                  <span class="bg-[#010a8b]/10 text-[#010a8b] px-1.5 py-0.5 rounded text-[10px] font-semibold" id="allBadge">0</span>
                </button>
                <button class="order-tab pb-3 px-3 border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-medium text-xs flex items-center gap-1.5 transition-all" id="tab-synced" onclick="switchTab('synced')">
                  <span>Synced</span>
                  <span class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-1.5 py-0.5 rounded text-[10px] font-semibold" id="syncedBadge">0</span>
                </button>
                <button class="order-tab pb-3 px-3 border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-medium text-xs flex items-center gap-1.5 transition-all" id="tab-pending" onclick="switchTab('pending')">
                  <span>Pending</span>
                  <span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-500 px-1.5 py-0.5 rounded text-[10px] font-semibold" id="pendingBadge">0</span>
                </button>
                <button class="order-tab pb-3 px-3 border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-medium text-xs flex items-center gap-1.5 transition-all" id="tab-failed" onclick="switchTab('failed')">
                  <span>Failed</span>
                  <span class="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-1.5 py-0.5 rounded text-[10px] font-semibold" id="failedBadge">0</span>
                </button>
              </div>
              
              <!-- Bulk Actions - Minimal Flat -->
              <div id="bulkActions" class="hidden px-4 py-2.5 bg-slate-50 dark:bg-slate-900/30 border-b border-border-light dark:border-border-dark flex items-center gap-2 flex-wrap">
                <span class="text-xs font-medium text-slate-600 dark:text-slate-400" id="bulkCount">0 selected</span>
                <div class="flex items-center gap-1.5 ml-auto">
                  <button class="inline-flex items-center px-3 py-1.5 bg-[#010a8b] text-white rounded-md text-xs font-semibold hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" id="bulkSyncBtn" onclick="syncSelectedOrders()" disabled>
                    <span class="material-icons-outlined text-sm mr-1">sync</span> Sync
                  </button>
                  <button class="inline-flex items-center px-3 py-1.5 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md text-xs font-semibold hover:border-[#010a8b] hover:text-[#010a8b] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="bulkRetryBtn" onclick="retryFailedOrders()" disabled>
                    <span class="material-icons-outlined text-sm mr-1">refresh</span> Retry
                  </button>
                </div>
              </div>
              
              <!-- Orders Table - Framer style -->
              <div class="overflow-x-auto">
                <table class="orders-table">
                  <thead>
                    <tr>
                      <th class="text-left" style="width: 50px; padding-left: 24px;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary">
                      </th>
                      <th class="text-left col-order-number">Order #</th>
                      <th class="text-left col-date">Date</th>
                      <th class="text-center col-payment">Payment</th>
                      <th class="text-left col-status">Status</th>
                      <th class="text-left col-delybell-id">Delybell ID</th>
                      <th class="text-right col-action" style="padding-right: 24px;">Action</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border-light dark:divide-border-dark" id="ordersContainer">
                    <tr>
                      <td colspan="7" class="text-center text-slate-500 dark:text-slate-400 py-8">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary mb-2"></div>
                        <div>Loading orders...</div>
                      </td>
                    </tr>
                  </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
              <div class="px-6 py-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between border-t border-border-light dark:border-border-dark">
                <span class="text-sm text-slate-500 dark:text-slate-400" id="paginationInfo">Loading...</span>
                <div class="flex space-x-2">
                  <button class="p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-400 cursor-not-allowed text-sm" id="prevPage" onclick="loadOrders(currentPage - 1)">Previous</button>
                  <button class="p-1 px-3 border border-border-light dark:border-border-dark rounded bg-white dark:bg-surface-dark text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm" id="nextPage" onclick="loadOrders(currentPage + 1)">Next</button>
                </div>
              </div>
            </div>
            
            <!-- Footer -->
            <footer class="mt-12 pt-8 border-t border-border-light dark:border-border-dark">
              <div class="flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-slate-500 dark:text-slate-400">
                <div class="flex items-center gap-6 flex-wrap">
                  <span class="font-semibold text-slate-700 dark:text-slate-300">Delybell Order Sync</span>
                  <a href="/app/help-center" class="hover:text-primary transition-colors">Help Center</a>
                  <a href="/privacy" class="hover:text-primary transition-colors">Privacy Policy</a>
                  <a href="/terms" class="hover:text-primary transition-colors">Terms of Service</a>
                </div>
                <div>
                  <p>&copy; ${new Date().getFullYear()} Delybell. All rights reserved.</p>
                </div>
              </div>
            </footer>
          `;
          
          loadOrders(1);
          updateOrderTabs();
        }
      } catch (error) {
        console.error('[App] Error loading app status:', error);
        const appContent = document.getElementById('app-content');
        if (appContent) {
          appContent.innerHTML = `
            <div class="bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 rounded-lg p-6">
              <div class="flex items-start space-x-3">
                <span class="material-icons-outlined text-red-600 dark:text-red-400">error</span>
                <div>
                  <h3 class="font-semibold text-red-900 dark:text-red-300 mb-1">Error Loading App</h3>
                  <p class="text-red-800 dark:text-red-400/80 text-sm">${error.message}</p>
                </div>
              </div>
            </div>
          `;
        }
      }
    }
    // Initialize with error handling
    console.log('[App] Page loaded, shop:', shop);
    
    // Wrap initialization in try-catch to prevent black screen
    try {
      loadAppStatus().catch(err => {
        console.error('[App] Error initializing app:', err);
        const appContent = document.getElementById('app-content');
        if (appContent) {
          appContent.innerHTML = `
            <div class="max-w-2xl mx-auto py-20">
              <div class="bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 rounded-lg p-6">
                <h3 class="font-semibold text-red-900 dark:text-red-300 mb-2">Error Loading App</h3>
                <p class="text-red-800 dark:text-red-400/80 text-sm mb-4">${err.message || 'Unknown error occurred'}</p>
                <button onclick="location.reload()" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700">
                  Reload Page
                </button>
              </div>
            </div>
          `;
        }
      });
    } catch (err) {
      console.error('[App] Fatal error during initialization:', err);
    }
    
    // Auto-refresh every 15 seconds to catch new orders quickly
    setInterval(() => {
      if (shop) {
        // Parallelize refresh calls
        Promise.all([
          loadConnectionHealth().catch(() => {}),
          loadOrders(currentPage).catch(() => {}),
          updateOrderTabs().catch(() => {})
        ]).catch(() => {}); // Silently fail to prevent breaking the interval
      }
    }, 15000);
    
    // Also refresh when tab becomes visible (user switches back to tab)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && shop) {
        Promise.all([
          loadOrders(currentPage).catch(() => {}),
          updateOrderTabs().catch(() => {})
        ]).catch(() => {});
      }
    });
  </script>
</body>
</html>
